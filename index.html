<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgencyOS â€” ç‰¹å·¥çŠ¶æ€</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #08090b;
      --bg-card: #0f1114;
      --bg-elevated: #16181c;
      --accent-red: #c41e3a;
      --accent-red-dark: #9e1830;
      --text-primary: #f0eeeb;
      --text-secondary: #a8b0b8;
      --border: #2a2e35;
      --blue-deep: #3b82f6;
      --glow-red: rgba(196, 30, 58, 0.5);
      --glow-red-soft: rgba(196, 30, 58, 0.25);
      --arc-anomaly: #2e4d92;
      --arc-reality: #daa520;
      --arc-competency: #c41e3a;
      --arc-items: #5a4a8a;
      --mvp-color: #c41e3a;
      --reprimand-color: #e67e22;
      --probation-color: #4a5a8a;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Sans SC', -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }

    /* Neon grid background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        linear-gradient(rgba(196, 30, 58, 0.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(196, 30, 58, 0.08) 1px, transparent 1px);
      background-size: 36px 36px;
      pointer-events: none;
      z-index: 0;
    }

    /* Triangle pattern overlay - alternating up/down triangles */
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cpolygon points='0,80 40,0 80,80' fill='rgba(196,30,58,0.05)'/%3E%3Cpolygon points='0,0 40,80 80,0' fill='rgba(196,30,58,0.05)'/%3E%3C/svg%3E");
      background-size: 80px 80px;
      pointer-events: none;
      z-index: 0;
    }

    body>* {
      position: relative;
      z-index: 1;
    }

    /* Top banner */
    .banner {
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 0 25px var(--glow-red-soft), 0 2px 0 rgba(0, 0, 0, 0.3);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: wrap;
      gap: 0.75rem;
      position: relative;
      z-index: 100;
    }

    .banner-ecg {
      flex: 0 0 auto;
      width: 260px;
      height: 24px;
      margin: 0 0.25rem;
      position: relative;
      overflow: hidden;
    }

    .banner-ecg::before {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 24'%3E%3Cpath fill='none' stroke='%23c41e3a' stroke-width='1' d='M0,12 L30,12 L33,11 L36,12 L38,5 L40,19 L42,12 L44,12 L46,13 L52,12 L80,12 L83,11 L86,12 L88,2 L90,22 L92,12 L94,12 L96,13 L102,12 L130,12 L133,11 L136,12 L138,10 L140,14 L142,12 L144,12 L146,13 L152,12 L180,12 L183,11 L186,12 L188,3 L190,21 L192,12 L200,12'/%3E%3C/svg%3E");
      background-repeat: repeat-x;
      background-size: 200px 24px;
      animation: ecg-scroll 2.8s linear infinite, ecg-pulse 4s ease-in-out infinite;
      filter: drop-shadow(0 0 4px rgba(196, 30, 58, 0.5)) drop-shadow(0 0 8px rgba(196, 30, 58, 0.25));
    }

    @keyframes ecg-scroll {
      0% {
        background-position: 0 0;
      }

      100% {
        background-position: 200px 0;
      }
    }

    @keyframes ecg-pulse {

      0%,
      100% {
        opacity: 0.65;
        filter: drop-shadow(0 0 4px rgba(196, 30, 58, 0.4)) drop-shadow(0 0 8px rgba(196, 30, 58, 0.2));
      }

      25% {
        opacity: 0.95;
        filter: drop-shadow(0 0 6px rgba(196, 30, 58, 0.6)) drop-shadow(0 0 12px rgba(196, 30, 58, 0.35));
      }

      50% {
        opacity: 0.5;
        filter: drop-shadow(0 0 3px rgba(196, 30, 58, 0.35)) drop-shadow(0 0 6px rgba(196, 30, 58, 0.15));
      }

      75% {
        opacity: 0.85;
        filter: drop-shadow(0 0 5px rgba(196, 30, 58, 0.55)) drop-shadow(0 0 10px rgba(196, 30, 58, 0.3));
      }
    }

    .banner-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .banner-triangle {
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 16px solid var(--accent-red);
      filter: drop-shadow(0 0 6px var(--glow-red));
    }

    .banner-title h1 {
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      color: var(--text-primary);
      text-shadow: 0 0 10px var(--glow-red-soft), 0 0 20px var(--glow-red-soft);
    }

    .banner-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
      min-width: 0;
    }

    .banner-buttons {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .agent-dropdown-wrap {
      position: relative;
      flex: 1;
      max-width: 280px;
      min-width: 0;
      z-index: 101;
    }

    .agent-dropdown-trigger {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .agent-dropdown-trigger:hover {
      border-color: var(--accent-red);
    }

    .agent-count {
      color: var(--accent-red);
      font-weight: 600;
    }

    .dropdown-arrow {
      margin-left: auto;
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .agent-dropdown-panel {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 0.25rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      max-height: 240px;
      overflow-y: auto;
    }

    .agent-dropdown-panel.open {
      display: block;
    }

    .agent-checkboxes {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .agent-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.25rem 0;
    }

    .agent-checkbox:hover {
      color: var(--accent-red);
    }

    .agent-checkbox input {
      width: 18px;
      height: 18px;
      accent-color: var(--accent-red);
      cursor: pointer;
      flex-shrink: 0;
    }

    .items-list-btn {
      padding: 0.5rem 1rem;
      background: rgba(196, 30, 58, 0.15);
      border: 1px solid rgba(196, 30, 58, 0.5);
      color: var(--arc-competency);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 8px var(--glow-red-soft);
    }

    .items-list-btn:hover {
      background: rgba(196, 30, 58, 0.25);
      box-shadow: 0 0 12px var(--glow-red-soft);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 1rem;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 0 30px var(--glow-red-soft);
      max-width: 560px;
      width: 100%;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-size: 1.1rem;
      color: var(--arc-items);
      font-weight: 600;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      line-height: 1;
      cursor: pointer;
      padding: 0.25rem;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 1rem 1.25rem;
      overflow-y: auto;
      flex: 1;
    }

    .items-list-loading {
      color: var(--text-secondary);
      text-align: center;
      padding: 2rem;
    }

    .items-list-modal .items-list-item {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 0.5rem;
      overflow: hidden;
    }

    .items-list-modal .items-list-item summary {
      padding: 0.6rem 0.75rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--arc-items);
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .items-list-modal .items-list-item summary::-webkit-details-marker {
      display: none;
    }

    .items-list-modal .items-list-item summary::before {
      content: '';
      display: inline-block;
      width: 0;
      height: 0;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      border-left: 5px solid currentColor;
      margin-right: 0.5rem;
      flex-shrink: 0;
      transition: transform 0.2s;
    }

    .items-list-modal .items-list-item[open] summary::before {
      transform: rotate(90deg);
    }

    .items-list-modal .items-list-item .item-price {
      flex-shrink: 0;
      color: var(--arc-reality);
      font-weight: 600;
    }

    .items-list-modal .items-list-item .item-desc {
      padding: 0 0.75rem 0.75rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-line;
    }

    .mission-archive-modal {
      max-width: 640px;
    }

    .mission-archive-modal .modal-title.mission-archive-title {
      color: var(--accent-red);
      text-shadow: 0 0 8px var(--glow-red-soft);
    }

    .mission-report-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding-bottom: 1rem;
      margin-bottom: 1.25rem;
      border-bottom: 1px solid rgba(196, 30, 58, 0.4);
      box-shadow: 0 1px 0 var(--glow-red-soft);
    }

    .mission-report-brand {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .mission-report-brand .mission-report-triangle {
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 12px solid var(--accent-red);
      filter: drop-shadow(0 0 4px var(--glow-red));
    }

    .mission-report-brand-text {
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      color: var(--accent-red);
      text-shadow: 0 0 8px var(--glow-red-soft);
    }

    .mission-report-brand-sub {
      font-size: 0.75rem;
      color: var(--text-secondary);
      letter-spacing: 0.05em;
      margin-top: 0.15rem;
    }

    .mission-archive-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .mission-archive-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      text-align: left;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }

    .mission-archive-item:hover {
      border-color: var(--accent-red);
      background: rgba(196, 30, 58, 0.08);
    }

    .mission-archive-date {
      color: var(--text-secondary);
      font-size: 0.85rem;
      min-width: 6rem;
    }

    .mission-archive-codename {
      font-weight: 600;
      color: var(--arc-competency);
    }

    .mission-back-btn {
      margin-top: 1.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .mission-back-btn:hover {
      color: var(--accent-red);
      border-color: var(--accent-red);
    }

    .mission-report {
      font-size: 0.9rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.2), 0 0 20px var(--glow-red-soft);
    }

    .mission-report-section {
      margin-bottom: 1.5rem;
      padding: 1rem 1.25rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      border-left: 3px solid var(--accent-red);
    }

    .mission-report-section:last-of-type {
      margin-bottom: 0;
    }

    .mission-report-header-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem 2rem;
      padding: 1rem 1.25rem;
      background: rgba(196, 30, 58, 0.08);
      border-radius: 6px;
      border: 1px solid rgba(196, 30, 58, 0.3);
      margin-bottom: 1.5rem;
      border-left: none;
    }

    .mission-report-header-item {
      display: flex;
      gap: 0.5rem;
    }

    .mission-report-header-item .mission-report-field {
      min-width: 4.5rem;
    }

    .mission-report-label {
      font-weight: 600;
      color: var(--accent-red);
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .mission-report-value {
      color: var(--text-primary);
      line-height: 1.6;
    }

    .mission-report-multiline {
      white-space: pre-line;
    }

    .mission-report-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 0.5rem 2rem;
    }

    .mission-report-row {
      display: contents;
    }

    .mission-report-row span:first-child {
      color: var(--text-secondary);
    }

    .mission-report-field {
      font-weight: 500;
      color: var(--arc-reality) !important;
    }

    .mission-report-analysis .mission-report-grid {
      padding-top: 0.5rem;
    }

    .mission-report-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem 2rem;
    }

    .mission-report-meta-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .mission-report-meta-row .mission-report-field {
      min-width: 5rem;
    }

    .mission-report-meta-row.score.å¯Ÿçœ‹æœŸ {
      color: #7a8fd4;
      text-shadow: 0 0 8px rgba(122, 143, 212, 0.5);
    }

    .mission-report-meta-row.score.å¯Ÿçœ‹æœŸ .score-icon,
    .mission-report-meta-row.score.å¯Ÿçœ‹æœŸ .mission-report-field {
      color: #7a8fd4 !important;
    }

    .mission-report-meta-row.score.å¯Ÿçœ‹æœŸ .score-icon {
      font-size: 0.9rem;
    }

    .mission-report-meta-row.score.mvp {
      color: var(--mvp-color);
      text-shadow: 0 0 6px var(--glow-red-soft);
    }

    .mission-report-meta-row.score.mvp .score-icon,
    .mission-report-meta-row.score.mvp .mission-report-field {
      color: var(--mvp-color) !important;
    }

    .mission-report-meta-row.score.mvp .score-icon {
      font-size: 0.9rem;
    }

    /* Main layout: left sidebar + content */
    .layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Left section */
    .sidebar {
      width: 280px;
      min-width: 280px;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      box-shadow: 2px 0 15px var(--glow-red-soft);
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .sidebar-section {
      background: var(--bg-elevated);
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid var(--border);
      box-shadow: 0 0 20px var(--glow-red-soft), inset 0 0 30px rgba(0, 0, 0, 0.2);
    }

    .sidebar-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent-red);
      text-shadow: 0 0 10px var(--glow-red-soft), 0 0 20px rgba(196, 30, 58, 0.15);
      margin-bottom: 0.75rem;
    }

    .agency-stats {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .agency-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .agency-stat .label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .agency-stat .value {
      font-weight: 600;
      font-size: 1.25rem;
      color: var(--accent-red);
      text-shadow: 0 0 12px var(--glow-red-soft), 0 0 4px var(--glow-red);
    }

    .agency-stat .value-text {
      font-weight: 500;
      font-size: 0.95rem;
      color: var(--text-primary);
      text-shadow: 0 0 6px var(--glow-red-soft);
    }

    .gm-profile {
      text-align: center;
      padding: 0.5rem 0;
    }

    .gm-profile-frame {
      display: inline-block;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 0 15px var(--glow-red-soft);
    }

    .gm-profile-frame img {
      display: block;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: inset 0 0 0 3px #000;
    }

    .gm-profile-frame .gm-profile-placeholder {
      display: flex;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      margin: 0;
      border: none;
      box-shadow: inset 0 0 0 3px #000;
    }

    .gm-info {
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }

    .gm-info-row {
      margin-bottom: 0.25rem;
      color: var(--text-primary);
    }

    .gm-info-row .label {
      color: var(--text-secondary);
      margin-right: 0.25rem;
    }

    .agency-news {
      flex: 1;
      min-height: 120px;
      max-height: 280px;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .agency-news-content {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.6;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }

    .agency-news-content::-webkit-scrollbar {
      width: 6px;
    }

    .agency-news-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .news-item {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }

    .news-item:last-child {
      border-bottom: none;
    }

    .news-item-date {
      font-size: 0.8rem;
      color: var(--accent-red);
      margin-bottom: 0.2rem;
    }

    .agency-news-placeholder {
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-style: italic;
    }

    /* Main section */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .main-content::-webkit-scrollbar {
      width: 8px;
    }

    .main-content::-webkit-scrollbar-track {
      background: var(--bg-dark);
    }

    .main-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .main-content::-webkit-scrollbar-thumb:hover {
      background: var(--accent-red-dark);
      box-shadow: 0 0 6px var(--glow-red-soft);
    }

    .agents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 1.25rem;
    }

    .agent-card {
      position: relative;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 25px var(--glow-red-soft), inset 0 0 40px rgba(0, 0, 0, 0.15);
      transition: box-shadow 0.2s, border-color 0.2s;
    }

    .agent-card:hover {
      border-color: var(--accent-red-dark);
      box-shadow: 0 0 25px var(--glow-red-soft), 0 0 40px var(--glow-red-soft);
    }

    .agent-badges {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      display: flex;
      gap: 0.35rem;
      z-index: 1;
      background: transparent;
    }

    .agent-badge-img {
      width: 64px;
      height: 64px;
      object-fit: contain;
      background: transparent;
    }

    .agent-card-header {
      background: var(--bg-elevated);
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 10px var(--glow-red-soft);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .agent-header-top {
      display: flex;
      gap: 1.25rem;
      align-items: center;
    }

    .agent-profile-slot {
      flex-shrink: 0;
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      overflow: hidden;
    }

    .agent-profile-pic {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--bg-dark);
      object-fit: cover;
      box-shadow: inset 0 0 0 2px #000, 0 0 12px var(--glow-red-soft);
      display: block;
    }

    .agent-profile-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.75rem;
      text-align: center;
      padding: 0.5rem;
      box-sizing: border-box;
      box-shadow: inset 0 0 0 2px #000;
    }

    .agent-name-row {
      flex: 1;
      min-width: 0;
    }

    .agent-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      text-shadow: 0 0 8px var(--glow-red-soft);
    }

    .agent-aka {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.15rem;
    }

    .agent-aka::before {
      content: 'AKA ';
      font-weight: 600;
      color: var(--accent-red);
    }

    .agent-title {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.15rem;
    }

    .agent-title .label {
      font-weight: 600;
      color: var(--accent-red);
      margin-right: 0.25rem;
    }

    .agent-agency-rating {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.15rem;
    }

    .agent-agency-rating .label {
      font-weight: 600;
      color: var(--accent-red);
      margin-right: 0.25rem;
    }

    .agent-agency-rating .rating-value.tier-0 {
      color: #34d399;
    }

    .agent-agency-rating .rating-value.tier-1-3 {
      color: var(--arc-reality);
    }

    .agent-agency-rating .rating-value.tier-4-6 {
      color: var(--reprimand-color);
    }

    .agent-agency-rating .rating-value.tier-7-9 {
      color: var(--arc-anomaly);
    }

    .agent-agency-rating .rating-value.tier-10 {
      color: var(--accent-red);
      font-weight: 700;
    }

    .arc-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      min-width: 0;
    }

    .arc-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .arc-badge.å¼‚å¸¸ {
      background: rgba(46, 77, 146, 0.2);
      color: var(--arc-anomaly);
      border: 1px solid rgba(46, 77, 146, 0.5);
      box-shadow: 0 0 8px rgba(46, 77, 146, 0.2);
    }

    .arc-badge.ç°å® {
      background: rgba(218, 165, 32, 0.15);
      color: var(--arc-reality);
      border: 1px solid rgba(218, 165, 32, 0.5);
      box-shadow: 0 0 8px rgba(218, 165, 32, 0.2);
    }

    .arc-badge.èŒèƒ½ {
      background: rgba(196, 30, 58, 0.15);
      color: var(--arc-competency);
      border: 1px solid rgba(196, 30, 58, 0.5);
      box-shadow: 0 0 8px var(--glow-red-soft);
    }

    .arc-badge-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      font-size: 0.65rem;
      font-weight: 700;
      border-radius: 2px;
    }

    .arc-badge.å¼‚å¸¸ .arc-badge-icon {
      background: var(--arc-anomaly);
      color: white;
    }

    .arc-badge.ç°å® .arc-badge-icon {
      background: var(--arc-reality);
      color: white;
    }

    .arc-badge.èŒèƒ½ .arc-badge-icon {
      background: var(--arc-competency);
      color: white;
    }

    .agent-scores {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem 1rem;
      margin-top: 0.5rem;
    }

    .score-group {
      display: inline-flex;
      flex-wrap: nowrap;
      gap: 1rem;
      align-items: center;
    }

    .score {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.85rem;
    }

    .score-icon {
      font-size: 0.9rem;
      line-height: 1;
    }

    .score.å˜‰å¥– {
      color: #34d399;
      text-shadow: 0 0 6px rgba(52, 211, 153, 0.3);
    }

    .score.å˜‰å¥– .score-icon {
      color: #34d399;
    }

    .score.ç”³è¯« {
      color: var(--reprimand-color);
      text-shadow: 0 0 6px rgba(230, 126, 34, 0.3);
    }

    .score.ç”³è¯« .score-icon {
      color: var(--reprimand-color);
    }

    .score.å¯Ÿçœ‹æœŸ {
      color: var(--probation-color);
      text-shadow: 0 0 6px rgba(74, 90, 138, 0.3);
    }

    .score.å¯Ÿçœ‹æœŸ .score-icon {
      color: var(--probation-color);
    }

    .score.mvp {
      color: var(--mvp-color);
      text-shadow: 0 0 6px var(--glow-red-soft);
    }

    .score.mvp .score-icon {
      color: var(--mvp-color);
    }

    .agent-body {
      padding: 1.25rem;
    }

    .section {
      margin-bottom: 1rem;
    }

    .section:last-child {
      margin-bottom: 0;
    }

    .section-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent-red);
      text-shadow: 0 0 6px var(--glow-red-soft);
      margin-bottom: 0.5rem;
      padding-bottom: 0.25rem;
      border-bottom: 1px solid var(--border);
    }

    .qa-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }

    .qa-item {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      padding: 0.25rem 0;
    }

    .qa-item .value {
      font-weight: 600;
      color: var(--blue-deep);
      text-shadow: 0 0 6px rgba(59, 130, 246, 0.3);
    }

    .ability-list {
      list-style: none;
    }

    .ability-item {
      margin-bottom: 0.75rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }

    .ability-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .ability-name {
      font-weight: 600;
      color: var(--accent-red);
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
      text-shadow: 0 0 4px var(--glow-red-soft);
    }

    .ability-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
      white-space: pre-line;
      line-height: 1.5;
    }

    .reference-section {
      margin-bottom: 1rem;
    }

    .ref-block {
      margin-bottom: 0.5rem;
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .ref-block.å¼‚å¸¸ {
      border-color: rgba(46, 77, 146, 0.5);
      box-shadow: 0 0 8px rgba(46, 77, 146, 0.2);
    }

    .ref-block.å¼‚å¸¸ .ref-block-title {
      background: rgba(46, 77, 146, 0.2);
      color: var(--arc-anomaly);
      padding: 0.5rem 0.75rem;
      text-shadow: 0 0 6px rgba(46, 77, 146, 0.4);
    }

    .ref-block.å¼‚å¸¸ .ref-item summary {
      color: var(--arc-anomaly);
      display: flex;
      align-items: center;
    }

    .ref-block.å¼‚å¸¸ .ref-item summary .ability-summary-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex: 1;
      min-width: 0;
    }

    .ref-block.å¼‚å¸¸ .ref-item summary .ability-name {
      color: inherit;
      text-shadow: none;
    }

    .ref-block.å¼‚å¸¸ .ability-proficient {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--arc-anomaly);
      flex-shrink: 0;
    }

    .ref-block.ç°å® {
      border-color: rgba(218, 165, 32, 0.5);
      box-shadow: 0 0 8px rgba(218, 165, 32, 0.2);
    }

    .ref-block.ç°å® .ref-block-title {
      background: rgba(218, 165, 32, 0.15);
      color: var(--arc-reality);
      padding: 0.5rem 0.75rem;
      text-shadow: 0 0 6px rgba(218, 165, 32, 0.4);
    }

    .ref-block.ç°å® .ref-item summary {
      color: var(--arc-reality);
    }

    .reality-split-tracker {
      display: flex;
      align-items: center;
      gap: 0;
      padding: 0.5rem 0 0;
    }

    .ref-block.ç°å® .ref-item-desc .reality-split-tracker {
      padding: 0.5rem 0 0;
    }

    .reality-split-tracker .tracker-start {
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-left: 12px solid var(--arc-reality);
      margin-right: 4px;
    }

    .reality-split-tracker .tracker-connector {
      flex: 0 0 8px;
      height: 2px;
      background: var(--arc-reality);
    }

    .reality-split-tracker .tracker-step {
      width: 24px;
      height: 24px;
      border: 2px solid var(--arc-reality);
      border-radius: 2px;
      background: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .reality-split-tracker .tracker-step.filled {
      background: var(--arc-reality);
      color: var(--bg-dark);
    }

    .reality-split-tracker .tracker-step.filled.warning {
      background: var(--reprimand-color);
      border-color: var(--reprimand-color);
      color: var(--accent-red);
    }

    .reality-split-tracker .tracker-end {
      width: 24px;
      height: 24px;
      border: 2px solid var(--arc-reality);
      border-radius: 50%;
      background: var(--arc-reality);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: white;
    }

    .reality-split-tracker .tracker-end.failed {
      background: var(--accent-red);
      border-color: var(--accent-red);
      color: white;
    }

    .ref-block.ç°å® .relationships-section {
      margin-top: 0.35rem;
    }

    .ref-block.ç°å® .relationships-list {
      padding: 0.35rem 0 0;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .ref-block.ç°å® .relationship-item {
      margin: 0.35rem 0 0.35rem 0.5rem;
      border-left: 2px solid rgba(218, 165, 32, 0.4);
      flex: 0 0 auto;
      min-height: 0;
      overflow: visible;
    }

    .ref-block.ç°å® .relationship-item summary {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .ref-block.ç°å® .relationship-item summary::before {
      display: none;
    }

    .ref-block.ç°å® .relationship-item .relationship-title-left {
      min-width: 0;
    }

    .ref-block.ç°å® .relationship-item .relationship-title-right {
      flex-shrink: 0;
    }

    .ref-block.ç°å® .relationship-content p {
      margin: 0 0 0.5rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-line;
    }

    .ref-block.ç°å® .relationship-content p:last-child {
      margin-bottom: 0;
    }

    .ref-block.ç°å® .relationship-benefit-title {
      font-weight: 600;
      margin-top: 0.5rem;
    }

    .ref-block.ç°å® .relationship-benefit-title .benefit-label {
      color: var(--arc-reality);
    }

    .ref-block.ç°å® .relationship-actor {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 0.35rem;
    }

    .ref-block.èŒèƒ½ {
      border-color: rgba(196, 30, 58, 0.5);
      box-shadow: 0 0 8px var(--glow-red-soft);
    }

    .ref-block.èŒèƒ½ .ref-block-title {
      background: rgba(196, 30, 58, 0.15);
      color: var(--arc-competency);
      padding: 0.5rem 0.75rem;
      text-shadow: 0 0 6px var(--glow-red-soft);
    }

    .ref-block.èŒèƒ½ .ref-item summary {
      color: var(--arc-competency);
    }

    .ref-block-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .ref-item {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      margin: 0.35rem 0.75rem 0.35rem;
      overflow: hidden;
    }

    .ref-item:first-of-type {
      margin-top: 0.35rem;
    }

    .ref-item:last-child {
      margin-bottom: 0.75rem;
    }

    .ref-item summary {
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      list-style: none;
    }

    .ref-item summary::-webkit-details-marker {
      display: none;
    }

    .ref-item summary::before {
      content: '';
      display: inline-block;
      width: 0;
      height: 0;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      border-left: 5px solid currentColor;
      margin-right: 0.5rem;
      vertical-align: middle;
      transition: transform 0.2s;
    }

    .ref-item[open] summary::before {
      transform: rotate(90deg);
    }

    .ref-item-desc {
      padding: 0 0.75rem 0.75rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-line;
    }

    .ref-block>.ref-item-desc {
      margin: 0.35rem 0.75rem 0.75rem;
    }

    .item-card {
      background: var(--bg-dark);
      border-radius: 4px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border: 1px solid var(--border);
      box-shadow: 0 0 10px var(--glow-red-soft);
    }

    .item-card details {
      border: none;
    }

    .item-card summary {
      list-style: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--accent-red);
      text-shadow: 0 0 4px var(--glow-red-soft);
      user-select: none;
    }

    .item-card summary::-webkit-details-marker {
      display: none;
    }

    .item-card summary::before {
      content: 'â–¶';
      display: inline-block;
      margin-right: 0.35rem;
      font-size: 0.7rem;
      transition: transform 0.2s;
    }

    .item-card details[open] summary::before {
      transform: rotate(90deg);
    }

    .item-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
      white-space: pre-line;
      line-height: 1.5;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border);
    }

    .loading,
    .error {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--text-secondary);
    }

    .error {
      color: var(--accent-red);
    }

    .no-results {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--text-secondary);
    }

    /* Subtle neon pulse */
    @keyframes neon-pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.85;
      }
    }

    .banner-title h1 {
      animation: neon-pulse 3s ease-in-out infinite;
    }

    .sidebar-title {
      animation: neon-pulse 4s ease-in-out infinite;
    }

    .agent-tabs {
      display: none;
    }

    .agent-tab {
      padding: 0.5rem 1rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 6px 6px 0 0;
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
    }

    .agent-tab:hover {
      color: var(--text-primary);
    }

    .agent-tab.active {
      background: var(--bg-card);
      color: var(--accent-red);
      border-color: var(--accent-red);
      font-weight: 600;
    }

    .agent-tab-panels {
      display: contents;
    }

    .agent-tab-panel {
      display: contents;
    }

    .agent-tab-panel.hidden {
      display: none;
    }

    @media (max-width: 768px) {
      .banner {
        flex-direction: column;
        align-items: stretch;
        padding: 0.75rem 1rem;
        gap: 0.5rem;
      }

      .banner-title {
        flex-shrink: 0;
      }

      .banner-title h1 {
        font-size: 1.25rem;
      }

      .banner-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
      }

      .banner-buttons {
        display: flex;
        flex-direction: row;
        gap: 0.5rem;
      }

      .banner-buttons .items-list-btn {
        flex: 1;
      }

      .agent-dropdown-wrap {
        max-width: 100%;
      }

      .items-list-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
      }

      .layout {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        min-width: unset;
        border-right: none;
        border-bottom: 1px solid var(--border);
        flex-direction: row;
        flex-wrap: wrap;
      }

      .sidebar-section {
        flex: 1;
        min-width: 140px;
      }

      .sidebar {
        display: none;
      }

      .banner-ecg {
        display: none;
      }

      .agent-tabs {
        display: flex;
        gap: 0.25rem;
        padding: 0.5rem 1rem 0;
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
        overflow-x: auto;
      }

      .main-content {
        flex: 1;
        overflow: auto;
      }

      .agents-grid {
        display: block;
      }

      .agents-grid .agent-card {
        display: none;
      }

      .agents-grid .agent-card.mobile-visible {
        display: block;
      }
    }

    @media (min-width: 1400px) {
      html {
        font-size: 18px;
      }

      .sidebar {
        width: 320px;
        min-width: 320px;
      }

      .agency-news {
        min-height: 140px;
        max-height: 320px;
      }

      .agents-grid {
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      }
    }

    @media (min-width: 1800px) {
      html {
        font-size: 20px;
      }

      .sidebar {
        width: 360px;
        min-width: 360px;
      }

      .agency-news {
        min-height: 160px;
        max-height: 360px;
      }

      .agents-grid {
        grid-template-columns: repeat(auto-fill, minmax(460px, 1fr));
      }
    }
  </style>
</head>

<body>
  <header class="banner">
    <div class="banner-title">
      <div class="banner-triangle"></div>
      <h1>AgencyOS</h1>
    </div>
    <div class="banner-ecg" aria-hidden="true"></div>
    <div class="banner-controls">
      <div class="agent-dropdown-wrap">
        <button class="agent-dropdown-trigger" id="agentDropdownTrigger">
          <span>é€‰æ‹©ç‰¹å·¥</span>
          <span class="agent-count" id="agentCount">å…¨éƒ¨</span>
          <span class="dropdown-arrow">â–¼</span>
        </button>
        <div class="agent-dropdown-panel" id="agentDropdownPanel"></div>
      </div>
      <div class="banner-buttons">
        <button class="items-list-btn" id="itemsListBtn">ç”³é¢†ç‰©åˆ—è¡¨</button>
        <button class="items-list-btn" id="missionArchiveBtn">ä»»åŠ¡æ¡£æ¡ˆåº“</button>
      </div>
    </div>
  </header>

  <div class="modal-overlay" id="missionArchiveModalOverlay">
    <div class="modal mission-archive-modal" id="missionArchiveModal">
      <div class="modal-header">
        <h3 class="modal-title mission-archive-title">ä»»åŠ¡æ¡£æ¡ˆåº“</h3>
        <button class="modal-close" type="button" aria-label="å…³é—­">Ã—</button>
      </div>
      <div class="modal-body" id="missionArchiveBody">
        <div class="mission-archive-list" id="missionArchiveList"></div>
        <div class="mission-archive-detail" id="missionArchiveDetail" style="display:none">
          <div class="mission-report" id="missionReportContent"></div>
          <button type="button" class="mission-back-btn" id="missionArchiveBack">â† è¿”å›åˆ—è¡¨</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="itemsListModalOverlay">
    <div class="modal items-list-modal" id="itemsListModal">
      <div class="modal-header">
        <h3 class="modal-title">ç”³é¢†ç‰©åˆ—è¡¨</h3>
        <button class="modal-close" type="button" aria-label="å…³é—­">Ã—</button>
      </div>
      <div class="modal-body" id="itemsListModalBody">
        <div class="items-list-loading">åŠ è½½ä¸­â€¦</div>
      </div>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-section agency-stats-section">
        <div class="sidebar-title">æœºæ„çŠ¶æ€</div>
        <div class="agency-stats">
          <div class="agency-stat">
            <span class="label">æ··æ²Œå€¼</span>
            <span class="value" id="chaosValue">â€”</span>
          </div>
          <div class="agency-stat">
            <span class="label">æ•£é€¸ç«¯</span>
            <span class="value" id="looseEnds">â€”</span>
          </div>
          <div class="agency-stat">
            <span class="label">ç°å®ç¨³å®šåº¦</span>
            <span class="value" id="realityStability">â€”</span>
          </div>
          <div class="agency-stat">
            <span class="label">åˆ†éƒ¨å</span>
            <span class="value">æ‚‰å°¼</span>
          </div>
        </div>
      </div>
      <div class="sidebar-section gm-profile-section">
        <div class="sidebar-title">æœºæ„æ€»ç»ç†</div>
        <div class="gm-profile">
          <div class="gm-profile-frame">
            <img src="assets/gm-profile.png" alt="æœºæ„æ€»ç»ç†"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
            <div class="gm-profile-placeholder"
              style="display:none; background:var(--bg-dark); align-items:center; justify-content:center; color:var(--text-secondary); font-size:0.8rem;">
              è¯·æ·»åŠ  assets/gm-profile.png</div>
          </div>
          <div class="gm-info">
            <div class="gm-info-row"><span class="label">å§“åï¼š</span>å“ˆé‡Œæ–¯.å¡è².D.å¨å°”æ–¯</div>
            <div class="gm-info-row"><span class="label">AKAï¼š</span>å“ˆé‡Œ</div>
          </div>
        </div>
      </div>
      <div class="sidebar-section agency-news agency-news-section">
        <div class="sidebar-title">æœºæ„åŠ¨æ€</div>
        <div class="agency-news-content" id="agencyNews">
          <span class="agency-news-placeholder">æš‚æ— åŠ¨æ€</span>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div id="content">
        <div class="loading">åŠ è½½ä¸­â€¦</div>
      </div>
    </main>
  </div>

  <script>
    const BASE = (window.location.pathname.replace(/\/index\.html$/, '').replace(/\/$/, '') || '.') + '/data';

    async function fetchJSON(filename) {
      const res = await fetch(`${BASE}/${filename}`);
      if (!res.ok) throw new Error(`åŠ è½½å¤±è´¥: ${res.status}`);
      return res.json();
    }

    let allAgents = [];
    let selectedAgentIndices = new Set();
    const MAX_SELECTED_AGENTS = 3;

    const AGENCY_RATINGS = [
      'è¯„çº§è‰¯å¥½',
      'æœ‰å¾…æ”¹è¿›',
      'äºŸå¾…æ”¹è¿›',
      'é‚£ä¸ªå‘˜å·¥',
      'ç‹¬è‡ªåˆé¤',
      'è¢«åŠ¨æ”»å‡»çš„ç›®æ ‡',
      'æœªè¢«é‚€è¯·å‚åŠ æ´¾å¯¹',
      'æˆ‘ä»¬æ›¾å¯¹ä½ å¯„äºˆåšæœ›',
      'å°šæœ‰æ”¹å˜çš„æ—¶é—´',
      'è¯·ä¸è¦è¿™ä¹ˆåš'
    ];

    function getAgencyRating(ç”³è¯«) {
      const n = Math.max(0, parseInt(ç”³è¯«, 10) || 0);
      return n >= 10 ? 'å†·å†»é…¸å¥¶å®¤æƒé™å·²æ’¤é”€ğŸš«' : (AGENCY_RATINGS[n] ?? 'â€”');
    }

    function getAgencyRatingTier(ç”³è¯«) {
      const n = Math.max(0, parseInt(ç”³è¯«, 10) || 0);
      if (n === 0) return 'tier-0';
      if (n <= 3) return 'tier-1-3';
      if (n <= 6) return 'tier-4-6';
      if (n <= 9) return 'tier-7-9';
      return 'tier-10';
    }

    function buildRefAnomalyHtml(agent) {
      const abilities = agent.arc?.å¼‚å¸¸?.abilities || [];
      if (abilities.length === 0) return '<div class="ref-item-desc">æ— </div>';
      return abilities.map(ab => `
        <details class="ref-item">
          <summary>
            <span class="ability-summary-inner">
              <span class="ability-name">${escapeHtml(ab.name || '')}</span>
              ${ab.ç†Ÿç»ƒ ? '<span class="ability-proficient">(ç†Ÿç»ƒ)</span>' : ''}
            </span>
          </summary>
          <div class="ref-item-desc">${escapeHtml(ab.description || '')}</div>
        </details>
      `).join('');
    }

    function buildRealitySplitTrackerHtml(å‰²è£‚è¿›åº¦) {
      const n = Math.min(4, Math.max(0, parseInt(å‰²è£‚è¿›åº¦, 10) || 0));
      let steps = '<div class="tracker-start"></div><div class="tracker-connector"></div>';
      for (let i = 1; i <= 4; i++) {
        const filled = i <= n;
        const warning = filled && i === 3;
        steps += `<div class="tracker-step${filled ? ' filled' : ''}${warning ? ' warning' : ''}">${i}</div>`;
        if (i < 4) steps += '<div class="tracker-connector"></div>';
      }
      steps += '<div class="tracker-connector"></div>';
      steps += `<div class="tracker-end${n >= 4 ? ' failed' : ''}">âœ•</div>`;
      return `<div class="reality-split-tracker">${steps}</div>`;
    }

    function buildRefRealityHtml(agent) {
      const arc = agent.arc?.ç°å®;
      if (!arc) return '<div class="ref-item-desc">æ— </div>';
      let html = '';
      if (arc.ç°å®è§¦å‘å™¨) {
        html += `<details class="ref-item">
          <summary>${escapeHtml(arc.ç°å®è§¦å‘å™¨.name || '')}</summary>
          <div class="ref-item-desc">${escapeHtml(arc.ç°å®è§¦å‘å™¨.description || '')}</div>
        </details>`;
      }
      if (arc.è¿‡è½½è§£é™¤) {
        html += `<details class="ref-item">
          <summary>${escapeHtml(arc.è¿‡è½½è§£é™¤.name || '')}</summary>
          <div class="ref-item-desc">${escapeHtml(arc.è¿‡è½½è§£é™¤.description || '')}</div>
        </details>`;
      }
      html += `<details class="ref-item">
        <summary>å‰²è£‚è¿›åº¦</summary>
        <div class="ref-item-desc">${buildRealitySplitTrackerHtml(arc.å‰²è£‚è¿›åº¦ ?? 0)}</div>
      </details>`;
      html += buildRelationshipsHtml(arc.å…³ç³» || []);
      return html || '<div class="ref-item-desc">æ— </div>';
    }

    function buildRelationshipsHtml(å…³ç³») {
      if (!å…³ç³» || å…³ç³».length === 0) return '';
      const itemsHtml = å…³ç³».map(rel => {
        const name = escapeHtml(rel.name || '');
        const actor = rel.actor ? escapeHtml(rel.actor) : '';
        const closeness = Math.min(9, Math.max(1, parseInt(rel.closeness, 10) || 0));
        const activeText = rel.benefitActive ? 'å·²æ¿€æ´»' : 'æœªæ¿€æ´»';
        const desc = escapeHtml(rel.description || '');
        const benefit = escapeHtml(rel.benefit || '');
        const benefitDesc = escapeHtml(rel.benefitDescription || '');
        let content = actor ? `<p class="relationship-actor">æ‰®æ¼”ï¼š${actor}</p>` : '';
        content += desc ? `<p class="relationship-desc">${desc}</p>` : '';
        if (benefit || benefitDesc) {
          content += `<p class="relationship-benefit-title"><span class="benefit-label">è¿ç»“åŠ æˆ</span>${benefit ? ' â€” ' + benefit : ''}</p>`;
          if (benefitDesc) content += `<p class="relationship-benefit-desc">${benefitDesc}</p>`;
        }
        return `<details class="ref-item relationship-item">
          <summary><span class="relationship-title-left">${name} è¿ç»“${closeness}</span><span class="relationship-title-right">${activeText}</span></summary>
          <div class="ref-item-desc relationship-content">${content || '<p>â€”</p>'}</div>
        </details>`;
      }).join('');
      return `<details class="ref-item relationships-section">
        <summary>å…³ç³»</summary>
        <div class="relationships-list">${itemsHtml}</div>
      </details>`;
    }

    function buildRefCompetencyHtml(agent) {
      const arc = agent.arc?.èŒèƒ½;
      if (!arc) return '<div class="ref-item-desc">æ— </div>';
      let html = '';
      if (arc.é¦–è¦æŒ‡ä»¤) {
        html += `<details class="ref-item">
          <summary>${escapeHtml(arc.é¦–è¦æŒ‡ä»¤.name || '')}</summary>
          <div class="ref-item-desc">${escapeHtml(arc.é¦–è¦æŒ‡ä»¤.description || '')}</div>
        </details>`;
      }
      if (arc.è®¸å¯è¡Œä¸º && arc.è®¸å¯è¡Œä¸º.length) {
        html += `<details class="ref-item">
          <summary>è®¸å¯è¡Œä¸º</summary>
          <div class="ref-item-desc">${arc.è®¸å¯è¡Œä¸º.map(p => 'â€¢ ' + escapeHtml(p)).join('\n')}</div>
        </details>`;
      }
      return html || '<div class="ref-item-desc">æ— </div>';
    }

    function renderAgent(agent) {
      const arc = agent.arc || {};
      const arcLabels = [
        { type: 'å¼‚å¸¸', choice: arc.å¼‚å¸¸?.choice, letter: 'A' },
        { type: 'ç°å®', choice: arc.ç°å®?.choice, letter: 'R' },
        { type: 'èŒèƒ½', choice: arc.èŒèƒ½?.choice, letter: 'C' }
      ];
      const arcBadgesHtml = arcLabels.map(({ type, choice, letter }) => `
        <span class="arc-badge ${type}">
          <span class="arc-badge-icon">${letter}</span>
          <span>${escapeHtml(choice || 'â€”')}</span>
        </span>
      `).join('');

      const scoresHtml = `
        <div class="agent-scores">
          <div class="score-group">
            <div class="score å˜‰å¥–"><span class="score-icon">â˜…</span>å˜‰å¥– <strong>${agent.å˜‰å¥– ?? 0}</strong></div>
            <div class="score ç”³è¯«"><span class="score-icon">âœ—</span>ç”³è¯« <strong>${agent.ç”³è¯« ?? 0}</strong></div>
          </div>
          <div class="score-group">
            <div class="score å¯Ÿçœ‹æœŸ"><span class="score-icon">â–£</span>å¯Ÿçœ‹æœŸ <strong>${agent.å¯Ÿçœ‹æœŸ ?? 0}</strong></div>
            <div class="score mvp"><span class="score-icon">â—†</span>MVP <strong>${agent.mvp ?? agent.ä»»åŠ¡MVP ?? 0}</strong></div>
          </div>
        </div>
      `;

      const qaQualities = ['ä¸“æ³¨', 'å…±æƒ…', 'æ°”åœº', 'æ¬ºç’', 'ä¸»åŠ¨', 'ä¸“ä¸š', 'æ´»åŠ›', 'åšæ¯…', 'è¯¡ç§˜'];
      const qa = agent.qa || {};
      const qaHtml = qaQualities.map(q => {
        const val = qa[q] != null ? Number(qa[q]) : 0;
        return `
        <div class="qa-item">
          <span>${q}</span>
          <span class="value">${val}</span>
        </div>
      `;
      }).join('');

      const itemsHtml = (agent.ç”³é¢†ç‰© || []).map(item => `
        <div class="item-card">
          <details>
            <summary>${escapeHtml(item.name)}</summary>
            <div class="item-desc">${escapeHtml(item.description || '')}</div>
          </details>
        </div>
      `).join('');

      const profilePicSrc = agent.profilePic || (agent.id ? `assets/${agent.id}.PNG` : null);
      const profilePicHtml = profilePicSrc
        ? `<div class="agent-profile-slot"><img class="agent-profile-pic" src="${escapeHtml(profilePicSrc)}" alt="${escapeHtml(agent.name || '')}" onerror="if(!this.dataset.retried){this.dataset.retried=1;this.src=this.src.replace(/\\.PNG$/i,'.png');}else{this.style.display='none';this.nextElementSibling.style.display='flex';}" /><div class="agent-profile-placeholder" style="display:none;">å¤´åƒ</div></div>`
        : `<div class="agent-profile-slot"><div class="agent-profile-placeholder">å¤´åƒ</div></div>`;

      const badgesHtml = [];
      if (agent.flag) badgesHtml.push('<img class="agent-badge-img" src="assets/flag.png" alt="flag" />');
      if (agent.socks) badgesHtml.push('<img class="agent-badge-img" src="assets/socks.png" alt="socks" />');
      const badgesEl = badgesHtml.length ? `<div class="agent-badges">${badgesHtml.join('')}</div>` : '';

      return `
        <div class="agent-card">
          ${badgesEl}
          <div class="agent-card-header">
            <div class="agent-header-top">
              ${profilePicHtml}
              <div class="agent-name-row">
                <div>
                  <div class="agent-name">${escapeHtml(agent.name || 'æœªå‘½åç‰¹å·¥')}</div>
                  ${agent.aka ? `<div class="agent-aka">${escapeHtml(agent.aka)}</div>` : ''}
                  ${agent.æœºæ„å¤´è¡” ? `<div class="agent-title"><span class="label">æœºæ„å¤´è¡”ï¼š</span>${escapeHtml(agent.æœºæ„å¤´è¡”)}</div>` : ''}
                  <div class="agent-agency-rating"><span class="label">æœºæ„è¯„çº§ï¼š</span><span class="rating-value ${getAgencyRatingTier(agent.ç”³è¯« ?? 0)}">${getAgencyRating(agent.ç”³è¯« ?? 0)}</span></div>
                </div>
                ${scoresHtml}
              </div>
            </div>
            <div class="arc-badges">${arcBadgesHtml}</div>
          </div>
          <div class="agent-body">
            <div class="section">
              <div class="section-title">èµ„è´¨ä¿è¯ (QA)</div>
              <div class="qa-grid">${qaHtml}</div>
            </div>
            <div class="reference-section">
              <div class="ref-block å¼‚å¸¸">
                <div class="ref-block-title">å¼‚å¸¸ â€” ${escapeHtml(arc.å¼‚å¸¸?.choice || 'â€”')}</div>
                ${buildRefAnomalyHtml(agent)}
              </div>
              <div class="ref-block ç°å®">
                <div class="ref-block-title">ç°å® â€” ${escapeHtml(arc.ç°å®?.choice || 'â€”')}</div>
                ${buildRefRealityHtml(agent)}
              </div>
              <div class="ref-block èŒèƒ½">
                <div class="ref-block-title">èŒèƒ½ â€” ${escapeHtml(arc.èŒèƒ½?.choice || 'â€”')}</div>
                ${buildRefCompetencyHtml(agent)}
              </div>
            </div>
            ${itemsHtml ? `
            <div class="section">
              <div class="section-title">ç”³é¢†ç‰©</div>
              ${itemsHtml}
            </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function renderAgentSelect() {
      const panel = document.getElementById('agentDropdownPanel');
      const trigger = document.getElementById('agentDropdownTrigger');
      const countEl = document.getElementById('agentCount');

      panel.innerHTML = `<div class="agent-checkboxes">${allAgents.map((a, i) => `
        <label class="agent-checkbox">
          <input type="checkbox" data-index="${i}" ${selectedAgentIndices.has(i) ? 'checked' : ''} ${!selectedAgentIndices.has(i) && selectedAgentIndices.size >= MAX_SELECTED_AGENTS ? 'disabled' : ''} />
          <span>${escapeHtml(a.name || 'æœªå‘½å')}${a.aka ? ` (${escapeHtml(a.aka)})` : ''}</span>
        </label>
      `).join('')}</div>`;

      panel.querySelectorAll('.agent-checkbox input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', (e) => {
          e.stopPropagation();
          const i = parseInt(cb.dataset.index);
          if (cb.checked) {
            if (selectedAgentIndices.size < MAX_SELECTED_AGENTS) {
              selectedAgentIndices.add(i);
            }
          } else {
            selectedAgentIndices.delete(i);
          }
          updateAgentCount();
          renderAgentSelect();
          renderContent();
        });
      });

      trigger.onclick = (e) => {
        e.stopPropagation();
        panel.classList.toggle('open');
      };

      if (!trigger._dropdownBound) {
        trigger._dropdownBound = true;
        document.addEventListener('click', (e) => {
          const wrap = document.querySelector('.agent-dropdown-wrap');
          if (wrap && !wrap.contains(e.target)) {
            panel.classList.remove('open');
          }
        });
      }

      function updateAgentCount() {
        const n = selectedAgentIndices.size;
        countEl.textContent = n > 0 ? `(${n})` : 'å…¨éƒ¨';
      }
      updateAgentCount();
    }

    function renderContent() {
      const content = document.getElementById('content');
      const hasSelection = selectedAgentIndices.size > 0;
      const indices = hasSelection ? [...selectedAgentIndices].sort((a, b) => a - b) : allAgents.map((_, i) => i);
      const agentIndexPairs = indices.map(i => ({ agent: allAgents[i], index: i })).filter(p => p.agent);

      if (agentIndexPairs.length === 0) {
        content.innerHTML = '<div class="no-results">æš‚æ— ç‰¹å·¥æ•°æ®</div>';
        return;
      }

      const showTabs = hasSelection && window.matchMedia('(max-width: 768px)').matches;
      const tabsHtml = showTabs ? agentIndexPairs.map((p, tabIdx) => {
        const label = p.agent.aka || p.agent.name || 'æœªå‘½å';
        return `<button type="button" class="agent-tab ${tabIdx === 0 ? 'active' : ''}" data-tab-index="${tabIdx}" data-agent-index="${p.index}">${escapeHtml(label)}</button>`;
      }).join('') : '';

      const cardsHtml = agentIndexPairs.map((p, i) => {
        const card = renderAgent(p.agent);
        return card.replace('<div class="agent-card">', `<div class="agent-card" data-agent-index="${p.index}" data-tab-index="${i}">`);
      }).join('');

      content.innerHTML = `
        <div class="agent-tabs">${tabsHtml}</div>
        <div class="agents-grid">${cardsHtml}</div>
      `;

      if (showTabs) {
        content.querySelectorAll('.agent-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabIndex = parseInt(tab.dataset.tabIndex);
            content.querySelectorAll('.agent-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            content.querySelectorAll('.agents-grid .agent-card').forEach(card => {
              const cardTabIdx = parseInt(card.dataset.tabIndex);
              card.classList.toggle('mobile-visible', cardTabIdx === tabIndex);
            });
          });
        });
        content.querySelectorAll('.agents-grid .agent-card').forEach((card, i) => {
          card.classList.toggle('mobile-visible', i === 0);
        });
      } else if (window.matchMedia('(max-width: 768px)').matches && !hasSelection) {
        content.querySelectorAll('.agents-grid .agent-card').forEach(card => {
          card.classList.add('mobile-visible');
        });
      }
    }

    async function load() {
      const content = document.getElementById('content');
      try {
        const data = await fetchJSON('statuses.json');
        document.getElementById('chaosValue').textContent = data.agency?.æ··æ²Œå€¼ ?? 'â€”';
        document.getElementById('looseEnds').textContent = data.agency?.æ•£é€¸ç«¯ ?? 'â€”';

        function updateRealityStability() {
          const pct = Math.floor(Math.random() * 21) + 75;
          document.getElementById('realityStability').textContent = pct + '%';
        }
        updateRealityStability();
        setInterval(updateRealityStability, 1000);

        const newsEl = document.getElementById('agencyNews');
        const newsArr = data.agency?.news;
        if (Array.isArray(newsArr) && newsArr.length > 0) {
          const sorted = [...newsArr].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
          newsEl.innerHTML = sorted.map(item => `
            <div class="news-item">
              <div class="news-item-date">${escapeHtml(item.date || '')}</div>
              <div>${escapeHtml(item.text || '')}</div>
            </div>
          `).join('');
        } else {
          newsEl.innerHTML = '<span class="agency-news-placeholder">æš‚æ— åŠ¨æ€</span>';
        }

        allAgents = Array.isArray(data.agents) ? data.agents : [];
        renderAgentSelect();
        renderContent();
      } catch (err) {
        content.innerHTML = `<div class="error">${escapeHtml(err.message)}</div>`;
      }
    }

    function openItemsListModal() {
      document.getElementById('itemsListModalOverlay').classList.add('open');
      const bodyEl = document.getElementById('itemsListModalBody');
      bodyEl.innerHTML = '<div class="items-list-loading">åŠ è½½ä¸­â€¦</div>';
      fetchJSON('items.json')
        .then(data => {
          const items = data?.items || [];
          if (items.length === 0) {
            bodyEl.innerHTML = '<div class="items-list-loading">æš‚æ— ç”³é¢†ç‰©</div>';
            return;
          }
          bodyEl.innerHTML = items.map(item => `
            <details class="items-list-item">
              <summary>
                <span class="item-title">${escapeHtml(item.name || '')}</span>
                <span class="item-price">${item.price != null ? item.price + ' å˜‰å¥–' : 'â€”'}</span>
              </summary>
              <div class="item-desc">${escapeHtml(item.description || '')}</div>
            </details>
          `).join('');
        })
        .catch(() => {
          bodyEl.innerHTML = '<div class="items-list-loading">åŠ è½½å¤±è´¥</div>';
        });
    }

    function closeItemsListModal() {
      document.getElementById('itemsListModalOverlay').classList.remove('open');
    }

    let missionArchiveData = { missions: [] };

    function openMissionArchiveModal() {
      document.getElementById('missionArchiveModalOverlay').classList.add('open');
      document.getElementById('missionArchiveList').style.display = '';
      document.getElementById('missionArchiveDetail').style.display = 'none';
      document.getElementById('missionArchiveList').innerHTML = '<div class="items-list-loading">åŠ è½½ä¸­â€¦</div>';
      fetchJSON('mission.json')
        .then(data => {
          missionArchiveData = data || { missions: [] };
          const missions = missionArchiveData.missions || [];
          if (missions.length === 0) {
            document.getElementById('missionArchiveList').innerHTML = '<div class="items-list-loading">æš‚æ— ä»»åŠ¡æŠ¥å‘Š</div>';
            return;
          }
          document.getElementById('missionArchiveList').innerHTML = missions.map((m, i) => `
            <button type="button" class="mission-archive-item" data-index="${i}">
              <span class="mission-archive-date">${escapeHtml(m.date || 'â€”')}</span>
              <span class="mission-archive-codename">${escapeHtml(m.ä»£å· || 'æœªå‘½å')}</span>
            </button>
          `).join('');
          document.getElementById('missionArchiveList').querySelectorAll('.mission-archive-item').forEach(btn => {
            btn.addEventListener('click', () => showMissionDetail(parseInt(btn.dataset.index, 10)));
          });
        })
        .catch(() => {
          document.getElementById('missionArchiveList').innerHTML = '<div class="items-list-loading">åŠ è½½å¤±è´¥</div>';
        });
    }

    function showMissionDetail(index) {
      const missions = Array.isArray(missionArchiveData.missions) ? missionArchiveData.missions : [];
      const m = missions[parseInt(index, 10)];
      if (!m) return;
      document.getElementById('missionArchiveList').style.display = 'none';
      document.getElementById('missionArchiveDetail').style.display = 'block';
      document.getElementById('missionReportContent').innerHTML = `
        <div class="mission-report-header">
          <div class="mission-report-brand">
            <div class="mission-report-triangle"></div>
            <div>
              <div class="mission-report-brand-text">TRIANGLE AGENCY</div>
              <div class="mission-report-brand-sub">ä»»åŠ¡æŠ¥å‘Š</div>
            </div>
          </div>
        </div>
        <div class="mission-report-section mission-report-header-row">
          <div class="mission-report-header-item"><span class="mission-report-field">å¼‚å¸¸çŠ¶æ€</span><span>${escapeHtml(m.å¼‚å¸¸çŠ¶æ€ || 'â€”')}</span></div>
          <div class="mission-report-header-item"><span class="mission-report-field">æœ€ç»ˆè¯„çº§</span><span>${escapeHtml(m.æœ€ç»ˆè¯„çº§ || 'â€”')}</span></div>
          <div class="mission-report-header-item"><span class="mission-report-field">æ—¥æœŸ</span><span>${escapeHtml(m.date || 'â€”')}</span></div>
        </div>
        <div class="mission-report-section mission-report-analysis">
          <div class="mission-report-label">å¼‚å¸¸åˆ†æ</div>
          <div class="mission-report-grid">
            <div class="mission-report-row"><span class="mission-report-field">ä»£å·</span><span>${escapeHtml(m.ä»£å· || 'â€”')}</span></div>
            <div class="mission-report-row"><span class="mission-report-field">è¡Œä¸º</span><span>${escapeHtml(m.è¡Œä¸º || 'â€”')}</span></div>
            <div class="mission-report-row"><span class="mission-report-field">ç„¦ç‚¹</span><span>${escapeHtml(m.ç„¦ç‚¹ || 'â€”')}</span></div>
            <div class="mission-report-row"><span class="mission-report-field">é¢†åŸŸ</span><span>${escapeHtml(m.é¢†åŸŸ || 'â€”')}</span></div>
          </div>
        </div>
        <div class="mission-report-section">
          <div class="mission-report-label">å‚ä¸è€…</div>
          <div class="mission-report-value mission-report-multiline">${escapeHtml(m.å‚ä¸è€… || 'â€”').replace(/\n/g, '<br>')}</div>
        </div>
        <div class="mission-report-section mission-report-meta">
          <div class="mission-report-meta-row score å¯Ÿçœ‹æœŸ"><span class="score-icon">â–£</span><span class="mission-report-field">å¯Ÿçœ‹æœŸ</span><span>${escapeHtml(m.å¯Ÿçœ‹æœŸ || 'â€”')}</span></div>
          <div class="mission-report-meta-row score mvp"><span class="score-icon">â—†</span><span class="mission-report-field">MVP</span><span>${escapeHtml(m.MVP || 'â€”')}</span></div>
        </div>
      `;
    }

    function closeMissionArchiveModal() {
      document.getElementById('missionArchiveModalOverlay').classList.remove('open');
    }

    document.getElementById('missionArchiveBtn').addEventListener('click', openMissionArchiveModal);
    document.getElementById('missionArchiveBack').addEventListener('click', () => {
      document.getElementById('missionArchiveList').style.display = '';
      document.getElementById('missionArchiveDetail').style.display = 'none';
    });
    document.getElementById('missionArchiveModalOverlay').addEventListener('click', e => {
      if (e.target.id === 'missionArchiveModalOverlay') closeMissionArchiveModal();
    });
    document.getElementById('missionArchiveModal').querySelector('.modal-close').addEventListener('click', closeMissionArchiveModal);

    document.getElementById('itemsListBtn').addEventListener('click', openItemsListModal);
    document.getElementById('itemsListModalOverlay').addEventListener('click', e => {
      if (e.target.id === 'itemsListModalOverlay') closeItemsListModal();
    });
    document.getElementById('itemsListModal').querySelector('.modal-close').addEventListener('click', closeItemsListModal);
    document.addEventListener('keydown', e => {
      if (e.key !== 'Escape') return;
      if (document.getElementById('missionArchiveModalOverlay').classList.contains('open')) closeMissionArchiveModal();
      else if (document.getElementById('itemsListModalOverlay').classList.contains('open')) closeItemsListModal();
    });

    load();
  </script>
</body>

</html>