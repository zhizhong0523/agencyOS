<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AgencyOS — 特工状态</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-dark: #08090b;
      --bg-card: #0f1114;
      --bg-elevated: #16181c;
      --accent-red: #c41e3a;
      --accent-red-dark: #9e1830;
      --text-primary: #f0eeeb;
      --text-secondary: #a8b0b8;
      --border: #2a2e35;
      --blue-deep: #3b82f6;
      --glow-red: rgba(196, 30, 58, 0.5);
      --glow-red-soft: rgba(196, 30, 58, 0.25);
      --arc-anomaly: #2e4d92;
      --arc-reality: #daa520;
      --arc-competency: #c41e3a;
      --arc-items: #5a4a8a;
      --mvp-color: #c41e3a;
      --reprimand-color: #e67e22;
      --probation-color: #4a5a8a;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Noto Sans SC', -apple-system, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
      line-height: 1.6;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow-x: hidden;
    }

    /* Neon grid background */
    body::before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image:
        linear-gradient(rgba(196, 30, 58, 0.08) 1px, transparent 1px),
        linear-gradient(90deg, rgba(196, 30, 58, 0.08) 1px, transparent 1px);
      background-size: 36px 36px;
      pointer-events: none;
      z-index: 0;
    }

    /* Triangle pattern overlay - alternating up/down triangles */
    body::after {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='80' height='80' viewBox='0 0 80 80'%3E%3Cpolygon points='0,80 40,0 80,80' fill='rgba(196,30,58,0.05)'/%3E%3Cpolygon points='0,0 40,80 80,0' fill='rgba(196,30,58,0.05)'/%3E%3C/svg%3E");
      background-size: 80px 80px;
      pointer-events: none;
      z-index: 0;
    }

    body>* {
      position: relative;
      z-index: 1;
    }

    /* Top banner */
    .banner {
      background: var(--bg-elevated);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 0 25px var(--glow-red-soft), 0 2px 0 rgba(0, 0, 0, 0.3);
      padding: 1rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: flex-start;
      flex-wrap: wrap;
      gap: 0.75rem;
      position: relative;
      z-index: 100;
    }

    .banner-ecg {
      flex: 0 0 auto;
      width: 260px;
      height: 24px;
      margin: 0 0.25rem;
      position: relative;
      overflow: hidden;
    }

    .banner-ecg::before {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 24'%3E%3Cpath fill='none' stroke='%23c41e3a' stroke-width='1' d='M0,12 L30,12 L33,11 L36,12 L38,5 L40,19 L42,12 L44,12 L46,13 L52,12 L80,12 L83,11 L86,12 L88,2 L90,22 L92,12 L94,12 L96,13 L102,12 L130,12 L133,11 L136,12 L138,10 L140,14 L142,12 L144,12 L146,13 L152,12 L180,12 L183,11 L186,12 L188,3 L190,21 L192,12 L200,12'/%3E%3C/svg%3E");
      background-repeat: repeat-x;
      background-size: 200px 24px;
      animation: ecg-scroll 2.8s linear infinite, ecg-pulse 4s ease-in-out infinite;
      filter: drop-shadow(0 0 4px rgba(196, 30, 58, 0.5)) drop-shadow(0 0 8px rgba(196, 30, 58, 0.25));
    }

    @keyframes ecg-scroll {
      0% {
        background-position: 0 0;
      }

      100% {
        background-position: 200px 0;
      }
    }

    @keyframes ecg-pulse {

      0%,
      100% {
        opacity: 0.65;
        filter: drop-shadow(0 0 4px rgba(196, 30, 58, 0.4)) drop-shadow(0 0 8px rgba(196, 30, 58, 0.2));
      }

      25% {
        opacity: 0.95;
        filter: drop-shadow(0 0 6px rgba(196, 30, 58, 0.6)) drop-shadow(0 0 12px rgba(196, 30, 58, 0.35));
      }

      50% {
        opacity: 0.5;
        filter: drop-shadow(0 0 3px rgba(196, 30, 58, 0.35)) drop-shadow(0 0 6px rgba(196, 30, 58, 0.15));
      }

      75% {
        opacity: 0.85;
        filter: drop-shadow(0 0 5px rgba(196, 30, 58, 0.55)) drop-shadow(0 0 10px rgba(196, 30, 58, 0.3));
      }
    }

    .banner-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .banner-triangle {
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 16px solid var(--accent-red);
      filter: drop-shadow(0 0 6px var(--glow-red));
    }

    .banner-title h1 {
      font-size: 1.5rem;
      font-weight: 600;
      letter-spacing: 0.05em;
      color: var(--text-primary);
      text-shadow: 0 0 10px var(--glow-red-soft), 0 0 20px var(--glow-red-soft);
    }

    .banner-controls {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      flex: 1;
      min-width: 0;
    }

    .banner-buttons {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .agent-dropdown-wrap {
      position: relative;
      flex: 1;
      max-width: 280px;
      min-width: 0;
      z-index: 101;
    }

    .agent-dropdown-trigger {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.6rem 1rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      transition: border-color 0.2s;
    }

    .agent-dropdown-trigger:hover {
      border-color: var(--accent-red);
    }

    .agent-count {
      color: var(--accent-red);
      font-weight: 600;
    }

    .dropdown-arrow {
      margin-left: auto;
      font-size: 0.7rem;
      opacity: 0.8;
    }

    .agent-dropdown-panel {
      display: none;
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 0.25rem;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      max-height: 240px;
      overflow-y: auto;
    }

    .agent-dropdown-panel.open {
      display: block;
    }

    .agent-checkboxes {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .agent-checkbox {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      font-size: 0.9rem;
      padding: 0.25rem 0;
    }

    .agent-checkbox:hover {
      color: var(--accent-red);
    }

    .agent-checkbox input {
      width: 18px;
      height: 18px;
      accent-color: var(--accent-red);
      cursor: pointer;
      flex-shrink: 0;
    }

    .items-list-btn {
      padding: 0.5rem 1rem;
      background: rgba(196, 30, 58, 0.15);
      border: 1px solid rgba(196, 30, 58, 0.5);
      color: var(--arc-competency);
      font-family: inherit;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      border-radius: 6px;
      transition: background 0.2s, box-shadow 0.2s;
      box-shadow: 0 0 8px var(--glow-red-soft);
    }

    .items-list-btn:hover {
      background: rgba(196, 30, 58, 0.25);
      box-shadow: 0 0 12px var(--glow-red-soft);
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 200;
      padding: 1rem;
    }

    .modal-overlay.open {
      display: flex;
    }

    .modal {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: 0 0 30px var(--glow-red-soft);
      max-width: 560px;
      width: 100%;
      max-height: 85vh;
      display: flex;
      flex-direction: column;
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
    }

    .modal-title {
      font-size: 1.1rem;
      color: var(--arc-items);
      font-weight: 600;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 1.5rem;
      line-height: 1;
      cursor: pointer;
      padding: 0.25rem;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 1rem 1.25rem;
      overflow-y: auto;
      flex: 1;
    }

    .items-list-loading {
      color: var(--text-secondary);
      text-align: center;
      padding: 2rem;
    }

    .items-list-modal .items-list-item {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      margin-bottom: 0.5rem;
      overflow: hidden;
    }

    .items-list-modal .items-list-item summary {
      padding: 0.6rem 0.75rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--arc-items);
      list-style: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .items-list-modal .items-list-item summary::-webkit-details-marker {
      display: none;
    }

    .items-list-modal .items-list-item summary::before {
      content: '';
      display: inline-block;
      width: 0;
      height: 0;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      border-left: 5px solid currentColor;
      margin-right: 0.5rem;
      flex-shrink: 0;
      transition: transform 0.2s;
    }

    .items-list-modal .items-list-item[open] summary::before {
      transform: rotate(90deg);
    }

    .items-list-modal .items-list-item .item-price {
      flex-shrink: 0;
      color: var(--arc-reality);
      font-weight: 600;
    }

    .items-list-modal .items-list-item .item-desc {
      padding: 0 0.75rem 0.75rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-line;
    }

    .mission-archive-modal {
      max-width: 640px;
    }

    .joint-assessment-modal {
      max-width: 680px;
    }

    .joint-assessment-modal .modal-title.joint-assessment-title {
      font-size: 0.9rem;
      color: var(--text-secondary);
      font-weight: 500;
      letter-spacing: 0.02em;
    }

    .ta-report {
      font-size: 0.85rem;
      line-height: 1.7;
      color: var(--text-primary);
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1.5rem;
      box-shadow: inset 0 0 40px rgba(0, 0, 0, 0.3), 0 0 15px var(--glow-red-soft);
    }

    .ta-report-header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(196, 30, 58, 0.3);
    }

    .ta-report-logo {
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.15em;
      color: var(--accent-red);
      text-shadow: 0 0 8px var(--glow-red-soft);
      margin-bottom: 0.25rem;
    }

    .ta-report-doc-type {
      font-size: 0.8rem;
      color: var(--text-secondary);
      letter-spacing: 0.08em;
      margin-bottom: 0.5rem;
    }

    .ta-report-meta {
      font-size: 0.7rem;
      color: var(--text-secondary);
      letter-spacing: 0.03em;
    }

    .ta-report-meta span {
      margin-right: 1rem;
    }

    .ta-report-section {
      margin-bottom: 1.25rem;
    }

    .ta-report-section-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--accent-red);
      letter-spacing: 0.05em;
      margin-bottom: 0.5rem;
      text-transform: uppercase;
    }

    .ta-report-body {
      color: var(--text-secondary);
      font-size: 0.82rem;
    }

    .ta-report-body p {
      margin: 0.4rem 0;
    }

    .ta-report-body .bullet {
      margin-left: 1rem;
      padding-left: 0.5rem;
      border-left: 2px solid rgba(196, 30, 58, 0.3);
    }

    .ta-report-body .redacted {
      color: var(--accent-red);
      letter-spacing: 0.2em;
    }

    .ta-report-divider {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(196, 30, 58, 0.3), transparent);
      margin: 1rem 0;
    }

    .ta-report-note {
      font-size: 0.75rem;
      color: var(--text-secondary);
      font-style: italic;
      margin-top: 0.5rem;
    }

    .mission-archive-modal .modal-title.mission-archive-title {
      color: var(--accent-red);
      text-shadow: 0 0 8px var(--glow-red-soft);
    }

    .mission-report-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      padding-bottom: 1rem;
      margin-bottom: 1.25rem;
      border-bottom: 1px solid rgba(196, 30, 58, 0.4);
      box-shadow: 0 1px 0 var(--glow-red-soft);
    }

    .mission-report-brand {
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .mission-report-brand .mission-report-triangle {
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-bottom: 12px solid var(--accent-red);
      filter: drop-shadow(0 0 4px var(--glow-red));
    }

    .mission-report-brand-text {
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      color: var(--accent-red);
      text-shadow: 0 0 8px var(--glow-red-soft);
    }

    .mission-report-brand-sub {
      font-size: 0.75rem;
      color: var(--text-secondary);
      letter-spacing: 0.05em;
      margin-top: 0.15rem;
    }

    .mission-archive-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .mission-archive-item {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.75rem 1rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-primary);
      font-family: inherit;
      font-size: 0.95rem;
      text-align: left;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }

    .mission-archive-item:hover {
      border-color: var(--accent-red);
      background: rgba(196, 30, 58, 0.08);
    }

    .mission-archive-date {
      color: var(--text-secondary);
      font-size: 0.85rem;
      min-width: 6rem;
    }

    .mission-archive-codename {
      font-weight: 600;
      color: var(--arc-competency);
    }

    .mission-back-btn {
      margin-top: 1.5rem;
      padding: 0.5rem 1rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }

    .mission-back-btn:hover {
      color: var(--accent-red);
      border-color: var(--accent-red);
    }

    .mission-report {
      font-size: 0.9rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.5rem;
      box-shadow: inset 0 0 30px rgba(0, 0, 0, 0.2), 0 0 20px var(--glow-red-soft);
    }

    .mission-report-section {
      margin-bottom: 1.5rem;
      padding: 1rem 1.25rem;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 6px;
      border-left: 3px solid var(--accent-red);
    }

    .mission-report-section:last-of-type {
      margin-bottom: 0;
    }

    .mission-report-header-row {
      display: flex;
      flex-wrap: wrap;
      gap: 1.5rem 2rem;
      padding: 1rem 1.25rem;
      background: rgba(196, 30, 58, 0.08);
      border-radius: 6px;
      border: 1px solid rgba(196, 30, 58, 0.3);
      margin-bottom: 1.5rem;
      border-left: none;
    }

    .mission-report-header-item {
      display: flex;
      gap: 0.5rem;
    }

    .mission-report-header-item .mission-report-field {
      min-width: 4.5rem;
    }

    .mission-report-label {
      font-weight: 600;
      color: var(--accent-red);
      margin-bottom: 0.5rem;
      font-size: 0.85rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .mission-report-value {
      color: var(--text-primary);
      line-height: 1.6;
    }

    .mission-report-multiline {
      white-space: pre-line;
    }

    .mission-report-grid {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 0.5rem 2rem;
    }

    .mission-report-row {
      display: contents;
    }

    .mission-report-row span:first-child {
      color: var(--text-secondary);
    }

    .mission-report-field {
      font-weight: 500;
      color: var(--arc-reality) !important;
    }

    .mission-report-analysis .mission-report-grid {
      padding-top: 0.5rem;
    }

    .mission-report-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem 2rem;
    }

    .mission-report-meta-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .mission-report-meta-row .mission-report-field {
      min-width: 5rem;
    }

    .mission-report-meta-row.score.察看期 {
      color: #7a8fd4;
      text-shadow: 0 0 8px rgba(122, 143, 212, 0.5);
    }

    .mission-report-meta-row.score.察看期 .score-icon,
    .mission-report-meta-row.score.察看期 .mission-report-field {
      color: #7a8fd4 !important;
    }

    .mission-report-meta-row.score.察看期 .score-icon {
      font-size: 0.9rem;
    }

    .mission-report-meta-row.score.mvp {
      color: var(--mvp-color);
      text-shadow: 0 0 6px var(--glow-red-soft);
    }

    .mission-report-meta-row.score.mvp .score-icon,
    .mission-report-meta-row.score.mvp .mission-report-field {
      color: var(--mvp-color) !important;
    }

    .mission-report-meta-row.score.mvp .score-icon {
      font-size: 0.9rem;
    }

    /* Main layout: left sidebar + content */
    .layout {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* Left section */
    .sidebar {
      width: 280px;
      min-width: 280px;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      box-shadow: 2px 0 15px var(--glow-red-soft);
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .sidebar-section {
      background: var(--bg-elevated);
      border-radius: 8px;
      padding: 1rem;
      border: 1px solid var(--border);
      box-shadow: 0 0 20px var(--glow-red-soft), inset 0 0 30px rgba(0, 0, 0, 0.2);
    }

    .gm-profile-section {
      position: relative;
    }

    .glitch-sos-btn {
      position: absolute;
      bottom: 0.5rem;
      right: 0.5rem;
      padding: 0.25rem 0.5rem;
      font-size: 0.65rem;
      font-family: monospace;
      color: rgba(196, 30, 58, 0.9);
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(196, 30, 58, 0.5);
      border-radius: 2px;
      cursor: pointer;
      letter-spacing: 0.08em;
      overflow: visible;
      animation: glitch-btn 3.5s steps(1) infinite;
    }

    .glitch-sos-btn:hover {
      color: var(--accent-red);
      border-color: var(--accent-red);
      background: rgba(196, 30, 58, 0.15);
      animation: none;
      box-shadow: 0 0 12px var(--glow-red-soft);
    }

    .glitch-text {
      position: relative;
      display: inline-block;
    }

    .glitch-text::before,
    .glitch-text::after {
      content: attr(data-text);
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
    }

    .glitch-sos-btn .glitch-text {
      animation: glitch-text 3.5s steps(1) infinite;
    }

    .glitch-sos-btn .glitch-text::before {
      content: attr(data-text);
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      color: #0ff;
      opacity: 0;
      clip-path: polygon(0 0, 100% 0, 100% 45%, 0 45%);
      animation: glitch-layer 3.5s steps(1) infinite;
    }

    .glitch-sos-btn .glitch-text::after {
      content: attr(data-text);
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      color: #f0f;
      opacity: 0;
      clip-path: polygon(0 55%, 100% 55%, 100% 100%, 0 100%);
      animation: glitch-layer 3.5s steps(1) infinite 0.05s;
    }

    @keyframes glitch-btn {
      0%, 25%, 50%, 75%, 97%, 100% { opacity: 1; transform: translate(0); }
      26% { opacity: 0.7; transform: translate(-2px, 2px); }
      27% { opacity: 1; transform: translate(2px, -2px); }
      28% { opacity: 1; transform: translate(0); }
      51% { opacity: 0.8; transform: translate(2px, -1px); }
      52% { opacity: 1; transform: translate(-1px, 1px); }
      53% { opacity: 1; transform: translate(0); }
      76% { opacity: 0.9; transform: translate(-1px, -1px); }
      77% { opacity: 1; transform: translate(1px, 1px); }
      78% { opacity: 1; transform: translate(0); }
    }

    @keyframes glitch-text {
      0%, 25%, 50%, 75%, 97%, 100% { transform: translate(0); text-shadow: none; }
      26% { transform: translate(2px, -2px); text-shadow: -2px 0 #0ff, 2px 0 #f0f; }
      27% { transform: translate(-2px, 2px); text-shadow: 2px 0 #0ff, -2px 0 #f0f; }
      28% { transform: translate(0); text-shadow: none; }
      51% { transform: translate(-1px, 1px); text-shadow: 1px 0 #0ff, -1px 0 #f0f; }
      52% { transform: translate(0); text-shadow: none; }
      76% { transform: translate(1px, -1px); text-shadow: -1px 0 #f0f, 1px 0 #0ff; }
      77% { transform: translate(0); text-shadow: none; }
    }

    @keyframes glitch-layer {
      0%, 25%, 50%, 75%, 97%, 100% { opacity: 0; transform: translate(0); }
      26% { opacity: 0.9; transform: translate(-2px, 0); }
      27% { opacity: 0.9; transform: translate(2px, 0); }
      28% { opacity: 0; transform: translate(0); }
      51% { opacity: 0.7; transform: translate(2px, 0); }
      52% { opacity: 0; transform: translate(0); }
      76% { opacity: 0.8; transform: translate(-2px, 0); }
      77% { opacity: 0; transform: translate(0); }
    }

    .sidebar-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent-red);
      text-shadow: 0 0 10px var(--glow-red-soft), 0 0 20px rgba(196, 30, 58, 0.15);
      margin-bottom: 0.75rem;
    }

    .agency-stats {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .agency-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .agency-stat .label {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }

    .agency-stat .value {
      font-weight: 600;
      font-size: 1.25rem;
      color: var(--accent-red);
      text-shadow: 0 0 12px var(--glow-red-soft), 0 0 4px var(--glow-red);
    }

    .agency-stat .value-text {
      font-weight: 500;
      font-size: 0.95rem;
      color: var(--text-primary);
      text-shadow: 0 0 6px var(--glow-red-soft);
    }

    .gm-profile {
      text-align: center;
      padding: 0.5rem 0;
    }

    .gm-profile-frame {
      display: inline-block;
      border-radius: 50%;
      overflow: hidden;
      box-shadow: 0 0 15px var(--glow-red-soft);
    }

    .gm-profile-frame img {
      display: block;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      object-fit: cover;
      box-shadow: inset 0 0 0 3px #000;
    }

    .gm-profile-frame .gm-profile-placeholder {
      display: flex;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      margin: 0;
      border: none;
      box-shadow: inset 0 0 0 3px #000;
    }

    .gm-info {
      margin-top: 0.75rem;
      font-size: 0.9rem;
    }

    .gm-info-row {
      margin-bottom: 0.25rem;
      color: var(--text-primary);
    }

    .gm-info-row .label {
      color: var(--text-secondary);
      margin-right: 0.25rem;
    }

    .agency-news {
      flex: 1;
      min-height: 120px;
      max-height: 280px;
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .agency-news-content {
      font-size: 0.9rem;
      color: var(--text-secondary);
      line-height: 1.6;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }

    .agency-news-content::-webkit-scrollbar {
      width: 6px;
    }

    .agency-news-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    .news-item {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }

    .news-item:last-child {
      border-bottom: none;
    }

    .news-item-date {
      font-size: 0.8rem;
      color: var(--accent-red);
      margin-bottom: 0.2rem;
    }

    .agency-news-placeholder {
      color: var(--text-secondary);
      font-size: 0.85rem;
      font-style: italic;
    }

    /* Main section */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }

    .main-content::-webkit-scrollbar {
      width: 8px;
    }

    .main-content::-webkit-scrollbar-track {
      background: var(--bg-dark);
    }

    .main-content::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    .main-content::-webkit-scrollbar-thumb:hover {
      background: var(--accent-red-dark);
      box-shadow: 0 0 6px var(--glow-red-soft);
    }

    .agents-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
      gap: 1.25rem;
    }

    .agent-card {
      position: relative;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 0 25px var(--glow-red-soft), inset 0 0 40px rgba(0, 0, 0, 0.15);
      transition: box-shadow 0.2s, border-color 0.2s;
    }

    .agent-card:hover {
      border-color: var(--accent-red-dark);
      box-shadow: 0 0 25px var(--glow-red-soft), 0 0 40px var(--glow-red-soft);
    }

    .agent-badges {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      display: flex;
      gap: 0.35rem;
      z-index: 1;
      background: transparent;
    }

    .agent-badge-img {
      width: 64px;
      height: 64px;
      object-fit: contain;
      background: transparent;
    }

    .agent-card-header {
      background: var(--bg-elevated);
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 10px var(--glow-red-soft);
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    .agent-header-top {
      display: flex;
      gap: 1.25rem;
      align-items: center;
    }

    .agent-profile-slot {
      flex-shrink: 0;
      position: relative;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      overflow: hidden;
    }

    .agent-profile-pic {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--bg-dark);
      object-fit: cover;
      box-shadow: inset 0 0 0 2px #000, 0 0 12px var(--glow-red-soft);
      display: block;
    }

    .agent-profile-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-secondary);
      font-size: 0.75rem;
      text-align: center;
      padding: 0.5rem;
      box-sizing: border-box;
      box-shadow: inset 0 0 0 2px #000;
    }

    .agent-name-row {
      flex: 1;
      min-width: 0;
    }

    .agent-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      text-shadow: 0 0 8px var(--glow-red-soft);
    }

    .agent-aka {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.15rem;
    }

    .agent-aka::before {
      content: 'AKA ';
      font-weight: 600;
      color: var(--accent-red);
    }

    .agent-title {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.15rem;
    }

    .agent-title .label {
      font-weight: 600;
      color: var(--accent-red);
      margin-right: 0.25rem;
    }

    .agent-agency-rating {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 0.15rem;
    }

    .agent-agency-rating .label {
      font-weight: 600;
      color: var(--accent-red);
      margin-right: 0.25rem;
    }

    .agent-agency-rating .rating-value.tier-0 {
      color: #34d399;
    }

    .agent-agency-rating .rating-value.tier-1-3 {
      color: var(--arc-reality);
    }

    .agent-agency-rating .rating-value.tier-4-6 {
      color: var(--reprimand-color);
    }

    .agent-agency-rating .rating-value.tier-7-9 {
      color: var(--arc-anomaly);
    }

    .agent-agency-rating .rating-value.tier-10 {
      color: var(--accent-red);
      font-weight: 700;
    }

    .arc-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      min-width: 0;
    }

    .arc-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.8rem;
      font-weight: 600;
      flex-shrink: 0;
      white-space: nowrap;
    }

    .arc-badge.异常 {
      background: rgba(46, 77, 146, 0.2);
      color: var(--arc-anomaly);
      border: 1px solid rgba(46, 77, 146, 0.5);
      box-shadow: 0 0 8px rgba(46, 77, 146, 0.2);
    }

    .arc-badge.现实 {
      background: rgba(218, 165, 32, 0.15);
      color: var(--arc-reality);
      border: 1px solid rgba(218, 165, 32, 0.5);
      box-shadow: 0 0 8px rgba(218, 165, 32, 0.2);
    }

    .arc-badge.职能 {
      background: rgba(196, 30, 58, 0.15);
      color: var(--arc-competency);
      border: 1px solid rgba(196, 30, 58, 0.5);
      box-shadow: 0 0 8px var(--glow-red-soft);
    }

    .arc-badge-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      font-size: 0.65rem;
      font-weight: 700;
      border-radius: 2px;
    }

    .arc-badge.异常 .arc-badge-icon {
      background: var(--arc-anomaly);
      color: white;
    }

    .arc-badge.现实 .arc-badge-icon {
      background: var(--arc-reality);
      color: white;
    }

    .arc-badge.职能 .arc-badge-icon {
      background: var(--arc-competency);
      color: white;
    }

    .agent-scores {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem 1rem;
      margin-top: 0.5rem;
    }

    .score-group {
      display: inline-flex;
      flex-wrap: nowrap;
      gap: 1rem;
      align-items: center;
    }

    .score {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      font-size: 0.85rem;
    }

    .score-icon {
      font-size: 0.9rem;
      line-height: 1;
    }

    .score.嘉奖 {
      color: #34d399;
      text-shadow: 0 0 6px rgba(52, 211, 153, 0.3);
    }

    .score.嘉奖 .score-icon {
      color: #34d399;
    }

    .score.申诫 {
      color: var(--reprimand-color);
      text-shadow: 0 0 6px rgba(230, 126, 34, 0.3);
    }

    .score.申诫 .score-icon {
      color: var(--reprimand-color);
    }

    .score.察看期 {
      color: var(--probation-color);
      text-shadow: 0 0 6px rgba(74, 90, 138, 0.3);
    }

    .score.察看期 .score-icon {
      color: var(--probation-color);
    }

    .score.mvp {
      color: var(--mvp-color);
      text-shadow: 0 0 6px var(--glow-red-soft);
    }

    .score.mvp .score-icon {
      color: var(--mvp-color);
    }

    .agent-body {
      padding: 1.25rem;
    }

    .section {
      margin-bottom: 1rem;
    }

    .section:last-child {
      margin-bottom: 0;
    }

    .section-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--accent-red);
      text-shadow: 0 0 6px var(--glow-red-soft);
      margin-bottom: 0.5rem;
      padding-bottom: 0.25rem;
      border-bottom: 1px solid var(--border);
    }

    .qa-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
    }

    .qa-item {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      padding: 0.25rem 0;
    }

    .qa-item .value {
      font-weight: 600;
      color: var(--blue-deep);
      text-shadow: 0 0 6px rgba(59, 130, 246, 0.3);
    }

    .ability-list {
      list-style: none;
    }

    .ability-item {
      margin-bottom: 0.75rem;
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border);
    }

    .ability-item:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .ability-name {
      font-weight: 600;
      color: var(--accent-red);
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
      text-shadow: 0 0 4px var(--glow-red-soft);
    }

    .ability-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
      white-space: pre-line;
      line-height: 1.5;
    }

    .reference-section {
      margin-bottom: 1rem;
    }

    .ref-block {
      margin-bottom: 0.5rem;
      border-radius: 4px;
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .ref-block.异常 {
      border-color: rgba(46, 77, 146, 0.5);
      box-shadow: 0 0 8px rgba(46, 77, 146, 0.2);
    }

    .ref-block.异常 .ref-block-title {
      background: rgba(46, 77, 146, 0.2);
      color: var(--arc-anomaly);
      padding: 0.5rem 0.75rem;
      text-shadow: 0 0 6px rgba(46, 77, 146, 0.4);
    }

    .ref-block.异常 .ref-item summary {
      color: var(--arc-anomaly);
      display: flex;
      align-items: center;
    }

    .ref-block.异常 .ref-item summary .ability-summary-inner {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex: 1;
      min-width: 0;
    }

    .ref-block.异常 .ref-item summary .ability-name {
      color: inherit;
      text-shadow: none;
    }

    .ref-block.异常 .ability-proficient {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--arc-anomaly);
      flex-shrink: 0;
    }

    .ref-block.现实 {
      border-color: rgba(218, 165, 32, 0.5);
      box-shadow: 0 0 8px rgba(218, 165, 32, 0.2);
    }

    .ref-block.现实 .ref-block-title {
      background: rgba(218, 165, 32, 0.15);
      color: var(--arc-reality);
      padding: 0.5rem 0.75rem;
      text-shadow: 0 0 6px rgba(218, 165, 32, 0.4);
    }

    .ref-block.现实 .ref-item summary {
      color: var(--arc-reality);
    }

    .reality-split-tracker {
      display: flex;
      align-items: center;
      gap: 0;
      padding: 0.5rem 0 0;
    }

    .ref-block.现实 .ref-item-desc .reality-split-tracker {
      padding: 0.5rem 0 0;
    }

    .reality-split-tracker .tracker-start {
      width: 0;
      height: 0;
      border-top: 8px solid transparent;
      border-bottom: 8px solid transparent;
      border-left: 12px solid var(--arc-reality);
      margin-right: 4px;
    }

    .reality-split-tracker .tracker-connector {
      flex: 0 0 8px;
      height: 2px;
      background: var(--arc-reality);
    }

    .reality-split-tracker .tracker-step {
      width: 24px;
      height: 24px;
      border: 2px solid var(--arc-reality);
      border-radius: 2px;
      background: var(--bg-dark);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .reality-split-tracker .tracker-step.filled {
      background: var(--arc-reality);
      color: var(--bg-dark);
    }

    .reality-split-tracker .tracker-step.filled.warning {
      background: var(--reprimand-color);
      border-color: var(--reprimand-color);
      color: var(--accent-red);
    }

    .reality-split-tracker .tracker-end {
      width: 24px;
      height: 24px;
      border: 2px solid var(--arc-reality);
      border-radius: 50%;
      background: var(--arc-reality);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
      font-weight: 700;
      color: white;
    }

    .reality-split-tracker .tracker-end.failed {
      background: var(--accent-red);
      border-color: var(--accent-red);
      color: white;
    }

    .ref-block.现实 .relationships-section {
      margin-top: 0.35rem;
    }

    .ref-block.现实 .relationships-list {
      padding: 0.35rem 0 0;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .ref-block.现实 .relationship-item {
      margin: 0.35rem 0 0.35rem 0.5rem;
      border-left: 2px solid rgba(218, 165, 32, 0.4);
      flex: 0 0 auto;
      min-height: 0;
      overflow: visible;
    }

    .ref-block.现实 .relationship-item summary {
      cursor: pointer;
      user-select: none;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.5rem;
    }

    .ref-block.现实 .relationship-item summary::before {
      display: none;
    }

    .ref-block.现实 .relationship-item .relationship-title-left {
      min-width: 0;
    }

    .ref-block.现实 .relationship-item .relationship-title-right {
      flex-shrink: 0;
    }

    .ref-block.现实 .relationship-content p {
      margin: 0 0 0.5rem;
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-line;
    }

    .ref-block.现实 .relationship-content p:last-child {
      margin-bottom: 0;
    }

    .ref-block.现实 .relationship-benefit-title {
      font-weight: 600;
      margin-top: 0.5rem;
    }

    .ref-block.现实 .relationship-benefit-title .benefit-label {
      color: var(--arc-reality);
    }

    .ref-block.现实 .relationship-actor {
      font-size: 0.8rem;
      color: var(--text-secondary);
      margin-bottom: 0.35rem;
    }

    .ref-block.职能 {
      border-color: rgba(196, 30, 58, 0.5);
      box-shadow: 0 0 8px var(--glow-red-soft);
    }

    .ref-block.职能 .ref-block-title {
      background: rgba(196, 30, 58, 0.15);
      color: var(--arc-competency);
      padding: 0.5rem 0.75rem;
      text-shadow: 0 0 6px var(--glow-red-soft);
    }

    .ref-block.职能 .ref-item summary {
      color: var(--arc-competency);
    }

    .ref-block-title {
      font-size: 0.9rem;
      font-weight: 600;
    }

    .ref-item {
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-radius: 4px;
      margin: 0.35rem 0.75rem 0.35rem;
      overflow: hidden;
    }

    .ref-item:first-of-type {
      margin-top: 0.35rem;
    }

    .ref-item:last-child {
      margin-bottom: 0.75rem;
    }

    .ref-item summary {
      padding: 0.5rem 0.75rem;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.85rem;
      list-style: none;
    }

    .ref-item summary::-webkit-details-marker {
      display: none;
    }

    .ref-item summary::before {
      content: '';
      display: inline-block;
      width: 0;
      height: 0;
      border-top: 4px solid transparent;
      border-bottom: 4px solid transparent;
      border-left: 5px solid currentColor;
      margin-right: 0.5rem;
      vertical-align: middle;
      transition: transform 0.2s;
    }

    .ref-item[open] summary::before {
      transform: rotate(90deg);
    }

    .ref-item-desc {
      padding: 0 0.75rem 0.75rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
      line-height: 1.5;
      white-space: pre-line;
    }

    .ref-block>.ref-item-desc {
      margin: 0.35rem 0.75rem 0.75rem;
    }

    .item-card {
      background: var(--bg-dark);
      border-radius: 4px;
      padding: 0.75rem;
      margin-bottom: 0.5rem;
      border: 1px solid var(--border);
      box-shadow: 0 0 10px var(--glow-red-soft);
    }

    .item-card details {
      border: none;
    }

    .item-card summary {
      list-style: none;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.9rem;
      color: var(--accent-red);
      text-shadow: 0 0 4px var(--glow-red-soft);
      user-select: none;
    }

    .item-card summary::-webkit-details-marker {
      display: none;
    }

    .item-card summary::before {
      content: '▶';
      display: inline-block;
      margin-right: 0.35rem;
      font-size: 0.7rem;
      transition: transform 0.2s;
    }

    .item-card details[open] summary::before {
      transform: rotate(90deg);
    }

    .item-desc {
      font-size: 0.8rem;
      color: var(--text-secondary);
      white-space: pre-line;
      line-height: 1.5;
      margin-top: 0.5rem;
      padding-top: 0.5rem;
      border-top: 1px solid var(--border);
    }

    .loading,
    .error {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--text-secondary);
    }

    .error {
      color: var(--accent-red);
    }

    .no-results {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--text-secondary);
    }

    /* Subtle neon pulse */
    @keyframes neon-pulse {

      0%,
      100% {
        opacity: 1;
      }

      50% {
        opacity: 0.85;
      }
    }

    .banner-title h1 {
      animation: neon-pulse 3s ease-in-out infinite;
    }

    .sidebar-title {
      animation: neon-pulse 4s ease-in-out infinite;
    }

    .agent-tabs {
      display: none;
    }

    .agent-tab {
      padding: 0.5rem 1rem;
      background: var(--bg-dark);
      border: 1px solid var(--border);
      border-bottom: none;
      border-radius: 6px 6px 0 0;
      color: var(--text-secondary);
      font-family: inherit;
      font-size: 0.9rem;
      cursor: pointer;
      transition: color 0.2s, border-color 0.2s;
    }

    .agent-tab:hover {
      color: var(--text-primary);
    }

    .agent-tab.active {
      background: var(--bg-card);
      color: var(--accent-red);
      border-color: var(--accent-red);
      font-weight: 600;
    }

    .agent-tab-panels {
      display: contents;
    }

    .agent-tab-panel {
      display: contents;
    }

    .agent-tab-panel.hidden {
      display: none;
    }

    @media (max-width: 768px) {
      .banner {
        flex-direction: column;
        align-items: stretch;
        padding: 0.75rem 1rem;
        gap: 0.5rem;
      }

      .banner-title {
        flex-shrink: 0;
      }

      .banner-title h1 {
        font-size: 1.25rem;
      }

      .banner-controls {
        flex-direction: column;
        align-items: stretch;
        gap: 0.5rem;
      }

      .banner-buttons {
        display: flex;
        flex-direction: row;
        gap: 0.5rem;
      }

      .banner-buttons .items-list-btn {
        flex: 1;
      }

      .agent-dropdown-wrap {
        max-width: 100%;
      }

      .items-list-btn {
        padding: 0.5rem 0.75rem;
        font-size: 0.85rem;
      }

      .layout {
        flex-direction: column;
      }

      .sidebar {
        width: 100%;
        min-width: unset;
        border-right: none;
        border-bottom: 1px solid var(--border);
        flex-direction: row;
        flex-wrap: wrap;
      }

      .sidebar-section {
        flex: 1;
        min-width: 140px;
      }

      .sidebar {
        display: none;
      }

      .banner-ecg {
        display: none;
      }

      .agent-tabs {
        display: flex;
        gap: 0.25rem;
        padding: 0.5rem 1rem 0;
        background: var(--bg-card);
        border-bottom: 1px solid var(--border);
        overflow-x: auto;
      }

      .main-content {
        flex: 1;
        overflow: auto;
      }

      .agents-grid {
        display: block;
      }

      .agents-grid .agent-card {
        display: none;
      }

      .agents-grid .agent-card.mobile-visible {
        display: block;
      }
    }

    @media (min-width: 1400px) {
      html {
        font-size: 18px;
      }

      .sidebar {
        width: 320px;
        min-width: 320px;
      }

      .agency-news {
        min-height: 140px;
        max-height: 320px;
      }

      .agents-grid {
        grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
      }
    }

    @media (min-width: 1800px) {
      html {
        font-size: 20px;
      }

      .sidebar {
        width: 360px;
        min-width: 360px;
      }

      .agency-news {
        min-height: 160px;
        max-height: 360px;
      }

      .agents-grid {
        grid-template-columns: repeat(auto-fill, minmax(460px, 1fr));
      }
    }
  </style>
</head>

<body>
  <header class="banner">
    <div class="banner-title">
      <div class="banner-triangle"></div>
      <h1>AgencyOS</h1>
    </div>
    <div class="banner-ecg" aria-hidden="true"></div>
    <div class="banner-controls">
      <div class="agent-dropdown-wrap">
        <button class="agent-dropdown-trigger" id="agentDropdownTrigger">
          <span>选择特工</span>
          <span class="agent-count" id="agentCount">全部</span>
          <span class="dropdown-arrow">▼</span>
        </button>
        <div class="agent-dropdown-panel" id="agentDropdownPanel"></div>
      </div>
      <div class="banner-buttons">
        <button class="items-list-btn" id="itemsListBtn">申领物列表</button>
        <button class="items-list-btn" id="missionArchiveBtn">任务档案库</button>
      </div>
    </div>
  </header>

  <div class="modal-overlay" id="missionArchiveModalOverlay">
    <div class="modal mission-archive-modal" id="missionArchiveModal">
      <div class="modal-header">
        <h3 class="modal-title mission-archive-title">任务档案库</h3>
        <button class="modal-close" type="button" aria-label="关闭">×</button>
      </div>
      <div class="modal-body" id="missionArchiveBody">
        <div class="mission-archive-list" id="missionArchiveList"></div>
        <div class="mission-archive-detail" id="missionArchiveDetail" style="display:none">
          <div class="mission-report" id="missionReportContent"></div>
          <button type="button" class="mission-back-btn" id="missionArchiveBack">← 返回列表</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="itemsListModalOverlay">
    <div class="modal items-list-modal" id="itemsListModal">
      <div class="modal-header">
        <h3 class="modal-title">申领物列表</h3>
        <button class="modal-close" type="button" aria-label="关闭">×</button>
      </div>
      <div class="modal-body" id="itemsListModalBody">
        <div class="items-list-loading">加载中…</div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="jointAssessmentModalOverlay">
    <div class="modal joint-assessment-modal" id="jointAssessmentModal">
      <div class="modal-header">
        <h3 class="modal-title joint-assessment-title">联合评估处理文件</h3>
        <button class="modal-close" type="button" aria-label="关闭">×</button>
      </div>
      <div class="modal-body">
        <div class="ta-report" id="jointAssessmentReport"></div>
      </div>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-section agency-stats-section">
        <div class="sidebar-title">机构状态</div>
        <div class="agency-stats">
          <div class="agency-stat">
            <span class="label">混沌值</span>
            <span class="value" id="chaosValue">—</span>
          </div>
          <div class="agency-stat">
            <span class="label">散逸端</span>
            <span class="value" id="looseEnds">—</span>
          </div>
          <div class="agency-stat">
            <span class="label">现实稳定度</span>
            <span class="value" id="realityStability">—</span>
          </div>
          <div class="agency-stat">
            <span class="label">分部名</span>
            <span class="value">悉尼</span>
          </div>
        </div>
      </div>
      <div class="sidebar-section gm-profile-section">
        <div class="sidebar-title">机构总经理</div>
        <div class="gm-profile">
          <div class="gm-profile-frame">
            <img src="assets/gm-profile.png" alt="机构总经理"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';" />
            <div class="gm-profile-placeholder"
              style="display:none; background:var(--bg-dark); align-items:center; justify-content:center; color:var(--text-secondary); font-size:0.8rem;">
              请添加 assets/gm-profile.png</div>
          </div>
          <div class="gm-info">
            <div class="gm-info-row"><span class="label">姓名：</span>哈里斯.卡菲.D.威尔斯</div>
            <div class="gm-info-row"><span class="label">AKA：</span>哈里</div>
          </div>
        </div>
        <button type="button" class="glitch-sos-btn" id="glitchSosBtn" aria-label="内部文件泄露SOS"><span class="glitch-text" data-text="内部文件泄露SOS">内部文件泄露SOS</span></button>
      </div>
      <div class="sidebar-section agency-news agency-news-section">
        <div class="sidebar-title">机构动态</div>
        <div class="agency-news-content" id="agencyNews">
          <span class="agency-news-placeholder">暂无动态</span>
        </div>
      </div>
    </aside>

    <main class="main-content">
      <div id="content">
        <div class="loading">加载中…</div>
      </div>
    </main>
  </div>

  <script>
    const BASE = (window.location.pathname.replace(/\/index\.html$/, '').replace(/\/$/, '') || '.') + '/data';

    async function fetchJSON(filename) {
      const res = await fetch(`${BASE}/${filename}`);
      if (!res.ok) throw new Error(`加载失败: ${res.status}`);
      return res.json();
    }

    let allAgents = [];
    let selectedAgentIndices = new Set();
    const MAX_SELECTED_AGENTS = 3;

    const AGENCY_RATINGS = [
      '评级良好',
      '有待改进',
      '亟待改进',
      '那个员工',
      '独自午餐',
      '被动攻击的目标',
      '未被邀请参加派对',
      '我们曾对你寄予厚望',
      '尚有改变的时间',
      '请不要这么做'
    ];

    function getAgencyRating(申诫) {
      const n = Math.max(0, parseInt(申诫, 10) || 0);
      return n >= 10 ? '冷冻酸奶室权限已撤销🚫' : (AGENCY_RATINGS[n] ?? '—');
    }

    function getAgencyRatingTier(申诫) {
      const n = Math.max(0, parseInt(申诫, 10) || 0);
      if (n === 0) return 'tier-0';
      if (n <= 3) return 'tier-1-3';
      if (n <= 6) return 'tier-4-6';
      if (n <= 9) return 'tier-7-9';
      return 'tier-10';
    }

    function buildRefAnomalyHtml(agent) {
      const abilities = agent.arc?.异常?.abilities || [];
      if (abilities.length === 0) return '<div class="ref-item-desc">无</div>';
      return abilities.map(ab => `
        <details class="ref-item">
          <summary>
            <span class="ability-summary-inner">
              <span class="ability-name">${escapeHtml(ab.name || '')}</span>
              ${ab.熟练 ? '<span class="ability-proficient">(熟练)</span>' : ''}
            </span>
          </summary>
          <div class="ref-item-desc">${escapeHtml(ab.description || '')}</div>
        </details>
      `).join('');
    }

    function buildRealitySplitTrackerHtml(割裂进度) {
      const n = Math.min(4, Math.max(0, parseInt(割裂进度, 10) || 0));
      let steps = '<div class="tracker-start"></div><div class="tracker-connector"></div>';
      for (let i = 1; i <= 4; i++) {
        const filled = i <= n;
        const warning = filled && i === 3;
        steps += `<div class="tracker-step${filled ? ' filled' : ''}${warning ? ' warning' : ''}">${i}</div>`;
        if (i < 4) steps += '<div class="tracker-connector"></div>';
      }
      steps += '<div class="tracker-connector"></div>';
      steps += `<div class="tracker-end${n >= 4 ? ' failed' : ''}">✕</div>`;
      return `<div class="reality-split-tracker">${steps}</div>`;
    }

    function buildRefRealityHtml(agent) {
      const arc = agent.arc?.现实;
      if (!arc) return '<div class="ref-item-desc">无</div>';
      let html = '';
      if (arc.现实触发器) {
        html += `<details class="ref-item">
          <summary>${escapeHtml(arc.现实触发器.name || '')}</summary>
          <div class="ref-item-desc">${escapeHtml(arc.现实触发器.description || '')}</div>
        </details>`;
      }
      if (arc.过载解除) {
        html += `<details class="ref-item">
          <summary>${escapeHtml(arc.过载解除.name || '')}</summary>
          <div class="ref-item-desc">${escapeHtml(arc.过载解除.description || '')}</div>
        </details>`;
      }
      html += `<details class="ref-item">
        <summary>割裂进度</summary>
        <div class="ref-item-desc">${buildRealitySplitTrackerHtml(arc.割裂进度 ?? 0)}</div>
      </details>`;
      html += buildRelationshipsHtml(arc.关系 || []);
      return html || '<div class="ref-item-desc">无</div>';
    }

    function buildRelationshipsHtml(关系) {
      if (!关系 || 关系.length === 0) return '';
      const itemsHtml = 关系.map(rel => {
        const name = escapeHtml(rel.name || '');
        const actor = rel.actor ? escapeHtml(rel.actor) : '';
        const closeness = Math.min(9, Math.max(1, parseInt(rel.closeness, 10) || 0));
        const activeText = rel.benefitActive ? '已激活' : '未激活';
        const desc = escapeHtml(rel.description || '');
        const benefit = escapeHtml(rel.benefit || '');
        const benefitDesc = escapeHtml(rel.benefitDescription || '');
        let content = actor ? `<p class="relationship-actor">扮演：${actor}</p>` : '';
        content += desc ? `<p class="relationship-desc">${desc}</p>` : '';
        if (benefit || benefitDesc) {
          content += `<p class="relationship-benefit-title"><span class="benefit-label">连结加成</span>${benefit ? ' — ' + benefit : ''}</p>`;
          if (benefitDesc) content += `<p class="relationship-benefit-desc">${benefitDesc}</p>`;
        }
        return `<details class="ref-item relationship-item">
          <summary><span class="relationship-title-left">${name} 连结${closeness}</span><span class="relationship-title-right">${activeText}</span></summary>
          <div class="ref-item-desc relationship-content">${content || '<p>—</p>'}</div>
        </details>`;
      }).join('');
      return `<details class="ref-item relationships-section">
        <summary>关系</summary>
        <div class="relationships-list">${itemsHtml}</div>
      </details>`;
    }

    function buildRefCompetencyHtml(agent) {
      const arc = agent.arc?.职能;
      if (!arc) return '<div class="ref-item-desc">无</div>';
      let html = '';
      if (arc.首要指令) {
        html += `<details class="ref-item">
          <summary>${escapeHtml(arc.首要指令.name || '')}</summary>
          <div class="ref-item-desc">${escapeHtml(arc.首要指令.description || '')}</div>
        </details>`;
      }
      if (arc.许可行为 && arc.许可行为.length) {
        html += `<details class="ref-item">
          <summary>许可行为</summary>
          <div class="ref-item-desc">${arc.许可行为.map(p => '• ' + escapeHtml(p)).join('\n')}</div>
        </details>`;
      }
      return html || '<div class="ref-item-desc">无</div>';
    }

    function renderAgent(agent) {
      const arc = agent.arc || {};
      const arcLabels = [
        { type: '异常', choice: arc.异常?.choice, letter: 'A' },
        { type: '现实', choice: arc.现实?.choice, letter: 'R' },
        { type: '职能', choice: arc.职能?.choice, letter: 'C' }
      ];
      const arcBadgesHtml = arcLabels.map(({ type, choice, letter }) => `
        <span class="arc-badge ${type}">
          <span class="arc-badge-icon">${letter}</span>
          <span>${escapeHtml(choice || '—')}</span>
        </span>
      `).join('');

      const scoresHtml = `
        <div class="agent-scores">
          <div class="score-group">
            <div class="score 嘉奖"><span class="score-icon">★</span>嘉奖 <strong>${agent.嘉奖 ?? 0}</strong></div>
            <div class="score 申诫"><span class="score-icon">✗</span>申诫 <strong>${agent.申诫 ?? 0}</strong></div>
          </div>
          <div class="score-group">
            <div class="score 察看期"><span class="score-icon">▣</span>察看期 <strong>${agent.察看期 ?? 0}</strong></div>
            <div class="score mvp"><span class="score-icon">◆</span>MVP <strong>${agent.mvp ?? agent.任务MVP ?? 0}</strong></div>
          </div>
        </div>
      `;

      const qaQualities = ['专注', '共情', '气场', '欺瞒', '主动', '专业', '活力', '坚毅', '诡秘'];
      const qa = agent.qa || {};
      const qaHtml = qaQualities.map(q => {
        const val = qa[q] != null ? Number(qa[q]) : 0;
        return `
        <div class="qa-item">
          <span>${q}</span>
          <span class="value">${val}</span>
        </div>
      `;
      }).join('');

      const itemsHtml = (agent.申领物 || []).map(item => `
        <div class="item-card">
          <details>
            <summary>${escapeHtml(item.name)}</summary>
            <div class="item-desc">${escapeHtml(item.description || '')}</div>
          </details>
        </div>
      `).join('');

      const profilePicSrc = agent.profilePic || (agent.id ? `assets/${agent.id}.PNG` : null);
      const profilePicHtml = profilePicSrc
        ? `<div class="agent-profile-slot"><img class="agent-profile-pic" src="${escapeHtml(profilePicSrc)}" alt="${escapeHtml(agent.name || '')}" onerror="if(!this.dataset.retried){this.dataset.retried=1;this.src=this.src.replace(/\\.PNG$/i,'.png');}else{this.style.display='none';this.nextElementSibling.style.display='flex';}" /><div class="agent-profile-placeholder" style="display:none;">头像</div></div>`
        : `<div class="agent-profile-slot"><div class="agent-profile-placeholder">头像</div></div>`;

      const badgesHtml = [];
      if (agent.flag) badgesHtml.push('<img class="agent-badge-img" src="assets/flag.png" alt="flag" />');
      if (agent.socks) badgesHtml.push('<img class="agent-badge-img" src="assets/socks.png" alt="socks" />');
      const badgesEl = badgesHtml.length ? `<div class="agent-badges">${badgesHtml.join('')}</div>` : '';

      return `
        <div class="agent-card">
          ${badgesEl}
          <div class="agent-card-header">
            <div class="agent-header-top">
              ${profilePicHtml}
              <div class="agent-name-row">
                <div>
                  <div class="agent-name">${escapeHtml(agent.name || '未命名特工')}</div>
                  ${agent.aka ? `<div class="agent-aka">${escapeHtml(agent.aka)}</div>` : ''}
                  ${agent.机构头衔 ? `<div class="agent-title"><span class="label">机构头衔：</span>${escapeHtml(agent.机构头衔)}</div>` : ''}
                  <div class="agent-agency-rating"><span class="label">机构评级：</span><span class="rating-value ${getAgencyRatingTier(agent.申诫 ?? 0)}">${getAgencyRating(agent.申诫 ?? 0)}</span></div>
                </div>
                ${scoresHtml}
              </div>
            </div>
            <div class="arc-badges">${arcBadgesHtml}</div>
          </div>
          <div class="agent-body">
            <div class="section">
              <div class="section-title">资质保证 (QA)</div>
              <div class="qa-grid">${qaHtml}</div>
            </div>
            <div class="reference-section">
              <div class="ref-block 异常">
                <div class="ref-block-title">异常 — ${escapeHtml(arc.异常?.choice || '—')}</div>
                ${buildRefAnomalyHtml(agent)}
              </div>
              <div class="ref-block 现实">
                <div class="ref-block-title">现实 — ${escapeHtml(arc.现实?.choice || '—')}</div>
                ${buildRefRealityHtml(agent)}
              </div>
              <div class="ref-block 职能">
                <div class="ref-block-title">职能 — ${escapeHtml(arc.职能?.choice || '—')}</div>
                ${buildRefCompetencyHtml(agent)}
              </div>
            </div>
            ${itemsHtml ? `
            <div class="section">
              <div class="section-title">申领物</div>
              ${itemsHtml}
            </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function escapeHtml(str) {
      if (!str) return '';
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function renderAgentSelect() {
      const panel = document.getElementById('agentDropdownPanel');
      const trigger = document.getElementById('agentDropdownTrigger');
      const countEl = document.getElementById('agentCount');

      panel.innerHTML = `<div class="agent-checkboxes">${allAgents.map((a, i) => `
        <label class="agent-checkbox">
          <input type="checkbox" data-index="${i}" ${selectedAgentIndices.has(i) ? 'checked' : ''} ${!selectedAgentIndices.has(i) && selectedAgentIndices.size >= MAX_SELECTED_AGENTS ? 'disabled' : ''} />
          <span>${escapeHtml(a.name || '未命名')}${a.aka ? ` (${escapeHtml(a.aka)})` : ''}</span>
        </label>
      `).join('')}</div>`;

      panel.querySelectorAll('.agent-checkbox input[type="checkbox"]').forEach(cb => {
        cb.addEventListener('change', (e) => {
          e.stopPropagation();
          const i = parseInt(cb.dataset.index);
          if (cb.checked) {
            if (selectedAgentIndices.size < MAX_SELECTED_AGENTS) {
              selectedAgentIndices.add(i);
            }
          } else {
            selectedAgentIndices.delete(i);
          }
          updateAgentCount();
          renderAgentSelect();
          renderContent();
        });
      });

      trigger.onclick = (e) => {
        e.stopPropagation();
        panel.classList.toggle('open');
      };

      if (!trigger._dropdownBound) {
        trigger._dropdownBound = true;
        document.addEventListener('click', (e) => {
          const wrap = document.querySelector('.agent-dropdown-wrap');
          if (wrap && !wrap.contains(e.target)) {
            panel.classList.remove('open');
          }
        });
      }

      function updateAgentCount() {
        const n = selectedAgentIndices.size;
        countEl.textContent = n > 0 ? `(${n})` : '全部';
      }
      updateAgentCount();
    }

    function renderContent() {
      const content = document.getElementById('content');
      const hasSelection = selectedAgentIndices.size > 0;
      const indices = hasSelection ? [...selectedAgentIndices].sort((a, b) => a - b) : allAgents.map((_, i) => i);
      const agentIndexPairs = indices.map(i => ({ agent: allAgents[i], index: i })).filter(p => p.agent);

      if (agentIndexPairs.length === 0) {
        content.innerHTML = '<div class="no-results">暂无特工数据</div>';
        return;
      }

      const showTabs = hasSelection && window.matchMedia('(max-width: 768px)').matches;
      const tabsHtml = showTabs ? agentIndexPairs.map((p, tabIdx) => {
        const label = p.agent.aka || p.agent.name || '未命名';
        return `<button type="button" class="agent-tab ${tabIdx === 0 ? 'active' : ''}" data-tab-index="${tabIdx}" data-agent-index="${p.index}">${escapeHtml(label)}</button>`;
      }).join('') : '';

      const cardsHtml = agentIndexPairs.map((p, i) => {
        const card = renderAgent(p.agent);
        return card.replace('<div class="agent-card">', `<div class="agent-card" data-agent-index="${p.index}" data-tab-index="${i}">`);
      }).join('');

      content.innerHTML = `
        <div class="agent-tabs">${tabsHtml}</div>
        <div class="agents-grid">${cardsHtml}</div>
      `;

      if (showTabs) {
        content.querySelectorAll('.agent-tab').forEach(tab => {
          tab.addEventListener('click', () => {
            const tabIndex = parseInt(tab.dataset.tabIndex);
            content.querySelectorAll('.agent-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            content.querySelectorAll('.agents-grid .agent-card').forEach(card => {
              const cardTabIdx = parseInt(card.dataset.tabIndex);
              card.classList.toggle('mobile-visible', cardTabIdx === tabIndex);
            });
          });
        });
        content.querySelectorAll('.agents-grid .agent-card').forEach((card, i) => {
          card.classList.toggle('mobile-visible', i === 0);
        });
      } else if (window.matchMedia('(max-width: 768px)').matches && !hasSelection) {
        content.querySelectorAll('.agents-grid .agent-card').forEach(card => {
          card.classList.add('mobile-visible');
        });
      }
    }

    async function load() {
      const content = document.getElementById('content');
      try {
        const data = await fetchJSON('statuses.json');
        document.getElementById('chaosValue').textContent = data.agency?.混沌值 ?? '—';
        document.getElementById('looseEnds').textContent = data.agency?.散逸端 ?? '—';

        function updateRealityStability() {
          const pct = Math.floor(Math.random() * 21) + 75;
          document.getElementById('realityStability').textContent = pct + '%';
        }
        updateRealityStability();
        setInterval(updateRealityStability, 1000);

        const newsEl = document.getElementById('agencyNews');
        const newsArr = data.agency?.news;
        if (Array.isArray(newsArr) && newsArr.length > 0) {
          const sorted = [...newsArr].sort((a, b) => (b.date || '').localeCompare(a.date || ''));
          newsEl.innerHTML = sorted.map(item => `
            <div class="news-item">
              <div class="news-item-date">${escapeHtml(item.date || '')}</div>
              <div>${escapeHtml(item.text || '')}</div>
            </div>
          `).join('');
        } else {
          newsEl.innerHTML = '<span class="agency-news-placeholder">暂无动态</span>';
        }

        allAgents = Array.isArray(data.agents) ? data.agents : [];
        renderAgentSelect();
        renderContent();
      } catch (err) {
        content.innerHTML = `<div class="error">${escapeHtml(err.message)}</div>`;
      }
    }

    function openItemsListModal() {
      document.getElementById('itemsListModalOverlay').classList.add('open');
      const bodyEl = document.getElementById('itemsListModalBody');
      bodyEl.innerHTML = '<div class="items-list-loading">加载中…</div>';
      fetchJSON('items.json')
        .then(data => {
          const items = data?.items || [];
          if (items.length === 0) {
            bodyEl.innerHTML = '<div class="items-list-loading">暂无申领物</div>';
            return;
          }
          bodyEl.innerHTML = items.map(item => `
            <details class="items-list-item">
              <summary>
                <span class="item-title">${escapeHtml(item.name || '')}</span>
                <span class="item-price">${item.price != null ? item.price + ' 嘉奖' : '—'}</span>
              </summary>
              <div class="item-desc">${escapeHtml(item.description || '')}</div>
            </details>
          `).join('');
        })
        .catch(() => {
          bodyEl.innerHTML = '<div class="items-list-loading">加载失败</div>';
        });
    }

    function closeItemsListModal() {
      document.getElementById('itemsListModalOverlay').classList.remove('open');
    }

    let missionArchiveData = { missions: [] };

    function openMissionArchiveModal() {
      document.getElementById('missionArchiveModalOverlay').classList.add('open');
      document.getElementById('missionArchiveList').style.display = '';
      document.getElementById('missionArchiveDetail').style.display = 'none';
      document.getElementById('missionArchiveList').innerHTML = '<div class="items-list-loading">加载中…</div>';
      fetchJSON('mission.json')
        .then(data => {
          missionArchiveData = data || { missions: [] };
          const missions = missionArchiveData.missions || [];
          if (missions.length === 0) {
            document.getElementById('missionArchiveList').innerHTML = '<div class="items-list-loading">暂无任务报告</div>';
            return;
          }
          document.getElementById('missionArchiveList').innerHTML = missions.map((m, i) => `
            <button type="button" class="mission-archive-item" data-index="${i}">
              <span class="mission-archive-date">${escapeHtml(m.date || '—')}</span>
              <span class="mission-archive-codename">${escapeHtml(m.代号 || '未命名')}</span>
            </button>
          `).join('');
          document.getElementById('missionArchiveList').querySelectorAll('.mission-archive-item').forEach(btn => {
            btn.addEventListener('click', () => showMissionDetail(parseInt(btn.dataset.index, 10)));
          });
        })
        .catch(() => {
          document.getElementById('missionArchiveList').innerHTML = '<div class="items-list-loading">加载失败</div>';
        });
    }

    function showMissionDetail(index) {
      const missions = Array.isArray(missionArchiveData.missions) ? missionArchiveData.missions : [];
      const m = missions[parseInt(index, 10)];
      if (!m) return;
      document.getElementById('missionArchiveList').style.display = 'none';
      document.getElementById('missionArchiveDetail').style.display = 'block';
      document.getElementById('missionReportContent').innerHTML = `
        <div class="mission-report-header">
          <div class="mission-report-brand">
            <div class="mission-report-triangle"></div>
            <div>
              <div class="mission-report-brand-text">TRIANGLE AGENCY</div>
              <div class="mission-report-brand-sub">任务报告</div>
            </div>
          </div>
        </div>
        <div class="mission-report-section mission-report-header-row">
          <div class="mission-report-header-item"><span class="mission-report-field">异常状态</span><span>${escapeHtml(m.异常状态 || '—')}</span></div>
          <div class="mission-report-header-item"><span class="mission-report-field">最终评级</span><span>${escapeHtml(m.最终评级 || '—')}</span></div>
          <div class="mission-report-header-item"><span class="mission-report-field">日期</span><span>${escapeHtml(m.date || '—')}</span></div>
        </div>
        <div class="mission-report-section mission-report-analysis">
          <div class="mission-report-label">异常分析</div>
          <div class="mission-report-grid">
            <div class="mission-report-row"><span class="mission-report-field">代号</span><span>${escapeHtml(m.代号 || '—')}</span></div>
            <div class="mission-report-row"><span class="mission-report-field">行为</span><span>${escapeHtml(m.行为 || '—')}</span></div>
            <div class="mission-report-row"><span class="mission-report-field">焦点</span><span>${escapeHtml(m.焦点 || '—')}</span></div>
            <div class="mission-report-row"><span class="mission-report-field">领域</span><span>${escapeHtml(m.领域 || '—')}</span></div>
          </div>
        </div>
        <div class="mission-report-section">
          <div class="mission-report-label">参与者</div>
          <div class="mission-report-value mission-report-multiline">${escapeHtml(m.参与者 || '—').replace(/\n/g, '<br>')}</div>
        </div>
        <div class="mission-report-section mission-report-meta">
          <div class="mission-report-meta-row score 察看期"><span class="score-icon">▣</span><span class="mission-report-field">察看期</span><span>${escapeHtml(m.察看期 || '—')}</span></div>
          <div class="mission-report-meta-row score mvp"><span class="score-icon">◆</span><span class="mission-report-field">MVP</span><span>${escapeHtml(m.MVP || '—')}</span></div>
        </div>
      `;
    }

    function closeMissionArchiveModal() {
      document.getElementById('missionArchiveModalOverlay').classList.remove('open');
    }

    document.getElementById('missionArchiveBtn').addEventListener('click', openMissionArchiveModal);
    document.getElementById('missionArchiveBack').addEventListener('click', () => {
      document.getElementById('missionArchiveList').style.display = '';
      document.getElementById('missionArchiveDetail').style.display = 'none';
    });
    document.getElementById('missionArchiveModalOverlay').addEventListener('click', e => {
      if (e.target.id === 'missionArchiveModalOverlay') closeMissionArchiveModal();
    });
    document.getElementById('missionArchiveModal').querySelector('.modal-close').addEventListener('click', closeMissionArchiveModal);

    document.getElementById('itemsListBtn').addEventListener('click', openItemsListModal);
    document.getElementById('itemsListModalOverlay').addEventListener('click', e => {
      if (e.target.id === 'itemsListModalOverlay') closeItemsListModal();
    });
    document.getElementById('itemsListModal').querySelector('.modal-close').addEventListener('click', closeItemsListModal);

    const JOINT_ASSESSMENT_REPORT = `
      <div class="ta-report-header">
        <div class="ta-report-logo">🔺 TRIANGLE AGENCY</div>
        <div class="ta-report-doc-type">联合评估处理文件</div>
        <div class="ta-report-meta">
          <span>文档等级：限制流通</span>
          <span>文档编号：TA–JOINT–Δ–071</span>
          <span>状态：有效｜已生效｜不可撤销</span>
        </div>
      </div>
      <div class="ta-report-section">
        <div class="ta-report-section-title">登记信息</div>
        <div class="ta-report-body">
          <p>评估对象登记名：Harris.Cafe.De.Wheels</p>
          <p>原行动代号：Iceman（已注销）</p>
          <p>原所属部门：研发部</p>
          <p>评估发起单位：三角机构</p>
          <p>联合评估单位：异常协调侧</p>
          <p>文件性质：最终处理记录</p>
        </div>
      </div>
      <div class="ta-report-section">
        <div class="ta-report-section-title">文件生成说明（当前可见版本）</div>
        <div class="ta-report-body">
          <p>本文件为罕见的联合生成文本。其生成过程未完全遵循常规审批路径。【原句已覆盖】"该文件的存在本身构成结构性异常。"当前版本允许被阅读，但不建议被理解。</p>
        </div>
      </div>
      <div class="ta-report-divider"></div>
      <div class="ta-report-section">
        <div class="ta-report-section-title">履历摘要（删减）</div>
        <div class="ta-report-body">
          <p>Iceman 曾参与多起现实稳定级别行动，其行动特征高度一致：</p>
          <p class="bullet">优先消除现实层不确定性</p>
          <p class="bullet">回避对异常的解释、记录与再利用</p>
          <p class="bullet">明确拒绝为异常提供"合理性"或"意义"</p>
          <p>其行动结果在短期内被评估为高度有效，但在中长期评估中暴露出以下问题：</p>
          <p class="bullet">异常残留率异常偏低</p>
          <p class="bullet">叙事复用价值为零</p>
          <p class="bullet">机构干预痕迹不可追溯</p>
          <p class="ta-report-note">注：相关成果最初由研发部归档，后因复现性不足被移出主评估体系。</p>
        </div>
      </div>
      <div class="ta-report-divider"></div>
      <div class="ta-report-section">
        <div class="ta-report-section-title">异常侧交互评估</div>
        <div class="ta-report-body">
          <p>自<span class="redacted">████████</span>起，异常对该个体表现出如下反应：</p>
          <p class="bullet">接触前自我瓦解</p>
          <p class="bullet">叙事锚点失效</p>
          <p class="bullet">观测记录中出现"未发生"的空段</p>
          <p>异常协调侧联合评估意见（摘要）：</p>
          <p>"目标个体拒绝最低限度叙事承认。" "继续接触将导致异常概念层死亡。"</p>
          <p>该评估直接导致：异常协调侧将目标列为非接触对象；所有异常利用方案被否决。</p>
        </div>
      </div>
      <div class="ta-report-divider"></div>
      <div class="ta-report-section">
        <div class="ta-report-section-title">机构侧冲突评估</div>
        <div class="ta-report-body">
          <p>问题不在于违规。问题在于结果。</p>
          <p>目标行为在统计意义上表明：</p>
          <p class="bullet">现实稳定可在低异常介入条件下持续</p>
          <p class="bullet">机构存在的必要性被削弱</p>
          <p class="bullet">三角结构被边缘化为"非必要解释层"</p>
          <p>机构侧结论摘要：</p>
          <p>"该个体正在证明一个危险前提：世界并不需要三角机构持续存在。" 该前提不可接受。</p>
        </div>
      </div>
      <div class="ta-report-divider"></div>
      <div class="ta-report-section">
        <div class="ta-report-section-title">最终处理决定（已执行）</div>
        <div class="ta-report-body">
          <p><strong>一、异常体剥离</strong></p>
          <p>异常体及其残留被系统性剥离个体。未发现抵抗、叙事回弹或记忆污染。剥离过程<span class="redacted">████████</span></p>
          <p class="ta-report-note">异常协调侧内部说明："这并非成功。" "这是异常第一次被如此彻底地忽略。"</p>
          <p><strong>二、现实关系保留（约束用途）</strong></p>
          <p>该个体的现实社会关系未被清除。相反，被完整保留、标记并锚定。包括但不限于：亲属关系、工作经历、未完成的人生路径。其功能不再是身份。而是要挟条件。</p>
          <p class="ta-report-note">机构内部说明：只要这些关系仍然存在，他就不会离开结构。不是因为忠诚，而是因为责任。</p>
          <p><strong>三、角色降级与重分配</strong></p>
          <p>原行动代号 Iceman 正式注销。一切现场与决策权限被中止。重分配至非行动、非决策岗位。对外称谓：总经理。对内功能：叙事调度与结构稳定单元。</p>
          <p>该岗位的本质定义为：让其持续观察却无法再介入；让其理解一切却无法再证明。</p>
        </div>
      </div>
      <div class="ta-report-divider"></div>
      <div class="ta-report-section">
        <div class="ta-report-section-title">当前状态评估</div>
        <div class="ta-report-body">
          <p>评估对象：Harris.Cafe.De.Wheels 哈里</p>
          <p class="bullet">保留全部记忆</p>
          <p class="bullet">失去一切行动可能</p>
          <p class="bullet">被允许存在，但不被允许改变</p>
          <p class="ta-report-note">异常协调侧最终注记："异常失去了一个敌人。" "也失去了一个见证者。"</p>
          <p class="ta-report-note">机构侧最终确认："他曾经是工具。" "现在是结构。"</p>
        </div>
      </div>
      <div class="ta-report-divider"></div>
      <div class="ta-report-section">
        <div class="ta-report-section-title">文件结语（联合确认）</div>
        <div class="ta-report-body">
          <p>本处理结果为当前条件下的唯一可行方案。不存在替代路径。</p>
          <p>本文件被反复修改的原因已不再重要。重要的是：每一次修改，结论都没有改变。</p>
          <p>当一个人完全站在现实一侧时，所有结构都会感到威胁。</p>
        </div>
      </div>
    `;

    function openJointAssessmentModal() {
      document.getElementById('jointAssessmentReport').innerHTML = JOINT_ASSESSMENT_REPORT;
      document.getElementById('jointAssessmentModalOverlay').classList.add('open');
    }

    function closeJointAssessmentModal() {
      document.getElementById('jointAssessmentModalOverlay').classList.remove('open');
    }

    document.getElementById('glitchSosBtn').addEventListener('click', openJointAssessmentModal);
    document.getElementById('jointAssessmentModalOverlay').addEventListener('click', e => {
      if (e.target.id === 'jointAssessmentModalOverlay') closeJointAssessmentModal();
    });
    document.getElementById('jointAssessmentModal').querySelector('.modal-close').addEventListener('click', closeJointAssessmentModal);

    document.addEventListener('keydown', e => {
      if (e.key !== 'Escape') return;
      if (document.getElementById('missionArchiveModalOverlay').classList.contains('open')) closeMissionArchiveModal();
      else if (document.getElementById('itemsListModalOverlay').classList.contains('open')) closeItemsListModal();
      else if (document.getElementById('jointAssessmentModalOverlay').classList.contains('open')) closeJointAssessmentModal();
    });

    load();
  </script>
</body>

</html>